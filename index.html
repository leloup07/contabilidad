<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aznar Legal & Compliance ‚Äî Plataforma Contable</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #F4F6F9; }
  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
  .modal { background: #fff; border-radius: 12px; padding: 28px; width: 90%; max-width: 620px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
  .modal h3 { color: #2E6B3A; margin-bottom: 18px; font-size: 18px; }
  .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
  .form-group { display: flex; flex-direction: column; flex: 1; }
  .form-group label { font-size: 11px; color: #7A8DA0; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; font-weight: 600; }
  .form-group input, .form-group select, .form-group textarea { padding: 8px 10px; border: 1px solid #D5DCE4; border-radius: 6px; font-size: 13px; font-family: system-ui; outline: none; transition: border 0.15s; }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #3D7A4A; }
  .btn { padding: 8px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; }
  .btn-primary { background: #3D7A4A; color: #fff; }
  .btn-primary:hover { background: #2E6B3A; }
  .btn-danger { background: #C0392B; color: #fff; }
  .btn-danger:hover { background: #A93226; }
  .btn-secondary { background: #E4E9F0; color: #2C3E50; }
  .btn-secondary:hover { background: #D5DCE4; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-export { background: #2980B9; color: #fff; }
  .btn-export:hover { background: #2471A3; }
  .action-bar { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
  .search-input { padding: 8px 12px; border: 1px solid #D5DCE4; border-radius: 6px; font-size: 13px; width: 220px; outline: none; }
  .search-input:focus { border-color: #3D7A4A; }
  @media print { .no-print { display: none !important; } }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback } = React;

const LOGO_SRC = "data:image/jpeg;base64,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";

// ‚îÄ‚îÄ‚îÄ DEFAULT DATA ‚îÄ‚îÄ‚îÄ
const DEFAULT_EMITIDAS_2024 = [
  { id: "e2024-1", num: "1/2024", fecha: "2024-06-03", cliente: "Fundaci√≥n Instituto de Empresa", nif: "G-81711459", desc: "Honorarios Direcci√≥n Observatorio IE-Elecnor (ene-abr 2024)", base: 3000, tipoIva: 21, iva: 630, total: 3630, trimestre: "Q2", doc: "docs/emitidas/2024/Factura_1_2024.pdf" },
  { id: "e2024-2", num: "3/2024", fecha: "2024-07-08", cliente: "Rivera del Campo", nif: "", desc: "Provisi√≥n de fondos constituci√≥n sociedad", base: 450, tipoIva: 0, iva: 0, total: 450, trimestre: "Q3", doc: "docs/emitidas/2024/Factura_3_2024.pdf" },
  { id: "e2024-3", num: "4/2024", fecha: "2024-10-15", cliente: "ICAB", nif: "Q0863003-J", desc: "Clase RSC y Gobernanza - Master Compliance", base: 300, tipoIva: 21, iva: 63, total: 363, trimestre: "Q4", doc: "docs/emitidas/2024/Factura_4_2024.pdf" },
  { id: "e2024-4", num: "5/2024", fecha: "2024-10-15", cliente: "Fundaci√≥n Instituto de Empresa", nif: "G-81711459", desc: "Honorarios Direcci√≥n Observatorio IE-Elecnor (may-sep 2024)", base: 3000, tipoIva: 21, iva: 630, total: 3630, trimestre: "Q4", doc: "docs/emitidas/2024/Factura_5_2024.pdf" },
  { id: "e2024-5", num: "6/2024", fecha: "2024-10-31", cliente: "ASCOM", nif: "G-87034120", desc: "Seminario Alta Direcci√≥n 2024 (exento art.20.9)", base: 300, tipoIva: 0, iva: 0, total: 300, trimestre: "Q4", doc: "docs/emitidas/2024/Factura_6_2024.pdf" },
  { id: "e2024-6", num: "7/2024", fecha: "2024-12-10", cliente: "Fundaci√≥n Instituto de Empresa", nif: "G-81711459", desc: "Honorarios Direcci√≥n Observatorio IE-Elecnor (sep-dic 2024)", base: 3000, tipoIva: 21, iva: 630, total: 3630, trimestre: "Q4", doc: "docs/emitidas/2024/Factura_7_2024.pdf" },
];
const DEFAULT_EMITIDAS_2025 = [
  { id: "e2025-1", num: "1/2025", fecha: "2025-02-26", cliente: "IEF", nif: "G-59190850", desc: "Curso CESCOM¬Æ Sesi√≥n 16: Prevenci√≥n soborno (exento)", base: 300, tipoIva: 0, iva: 0, total: 300, trimestre: "Q1", doc: "docs/emitidas/2025/Factura_1_2025.pdf" },
  { id: "e2025-2", num: "2/2025", fecha: "2025-03-27", cliente: "IEF", nif: "G-59190850", desc: "Curso CESCOM¬Æ Sesi√≥n 6: RSC y buen gobierno (exento)", base: 300, tipoIva: 0, iva: 0, total: 300, trimestre: "Q1", doc: "docs/emitidas/2025/Factura_2_2025.pdf" },
  { id: "e2025-3", num: "3/2025", fecha: "2025-04-04", cliente: "Blockchain Intelligence", nif: "B05490057", desc: "Clase tokenizaci√≥n mobiliaria", base: 225, tipoIva: 0, iva: 0, total: 225, trimestre: "Q2", doc: "docs/emitidas/2025/Factura_3_2025.pdf" },
  { id: "e2025-4", num: "4/2025", fecha: "2025-05-14", cliente: "IEF", nif: "G-59190850", desc: "Curso CESCOM¬Æ Sesi√≥n 18 (exento)", base: 300, tipoIva: 0, iva: 0, total: 300, trimestre: "Q2", doc: "docs/emitidas/2025/Factura_4_2025.pdf" },
  { id: "e2025-5", num: "5/2025", fecha: "2025-06-23", cliente: "Fundaci√≥n Instituto de Empresa", nif: "G-81711459", desc: "Honorarios IE-Elecnor Knowledge Hub (ene-abr 2025)", base: 3000, tipoIva: 21, iva: 630, total: 3630, trimestre: "Q2", doc: "docs/emitidas/2025/Factura_5_2025.pdf" },
  { id: "e2025-6", num: "6/2025", fecha: "2025-09-26", cliente: "ASCOM", nif: "G-87034120", desc: "Seminario Alta Direcci√≥n (exento art.20.9)", base: 300, tipoIva: 0, iva: 0, total: 300, trimestre: "Q3", doc: "docs/emitidas/2025/Factura_6_2025.pdf" },
  { id: "e2025-7", num: "7/2025", fecha: "2025-10-20", cliente: "ICAB", nif: "Q0863003-J", desc: "Clase RSC Sesi√≥n 5 - Master Compliance", base: 300, tipoIva: 21, iva: 63, total: 363, trimestre: "Q4", doc: "docs/emitidas/2025/Factura_7_2025.pdf" },
  { id: "e2025-8", num: "8/2025", fecha: "2025-10-20", cliente: "Fundaci√≥n Instituto de Empresa", nif: "G-81711459", desc: "Honorarios IE-Elecnor Knowledge Hub (may-ago 2025)", base: 3000, tipoIva: 21, iva: 630, total: 3630, trimestre: "Q4", doc: "docs/emitidas/2025/Factura_8_2025.pdf" },
  { id: "e2025-9", num: "9/2025", fecha: "2025-12-11", cliente: "Fundaci√≥n Instituto de Empresa", nif: "G-81711459", desc: "Honorarios IE-Elecnor Knowledge Hub (sep-dic 2025)", base: 3000, tipoIva: 21, iva: 630, total: 3630, trimestre: "Q4", doc: "docs/emitidas/2025/Factura_9_2025.pdf" },
  { id: "e2025-10", num: "10/2025", fecha: "2025-12-17", cliente: "Maximiliano Vergara (Bitrise)", nif: "Chile-F62258086", desc: "Asesoramiento jur√≠dico 50% iguala dic (no sujeto art.69)", base: 375, tipoIva: 0, iva: 0, total: 375, trimestre: "Q4", doc: "docs/emitidas/2025/Factura_10_2025.pdf" },
  { id: "e2025-11", num: "11/2025", fecha: "2025-12-30", cliente: "Maximiliano Vergara (Bitrise)", nif: "Chile-F62258086", desc: "2¬∫ 50% dic + 1er 50% ene 2026 (no sujeto art.69)", base: 1000, tipoIva: 0, iva: 0, total: 1000, trimestre: "Q4", doc: "docs/emitidas/2025/Factura_11_2025.pdf" },
];
const DEFAULT_RECIBIDAS_2024 = [
  { id: "r2024-1", fecha: "2024-01-13", prov: "Movistar", desc: "Telecom (28 Nov-27 Dic)", base: 185.33, tipoIva: 21, iva: 38.92, total: 224.25, cat: "Telecom", trimestre: "Q1", doc: "docs/recibidas/2024/Movistar_ene_2024.pdf" },
  { id: "r2024-2", fecha: "2024-02-13", prov: "Movistar", desc: "Telecom (28 Dic-27 Ene)", base: 153.43, tipoIva: 21, iva: 32.22, total: 185.65, cat: "Telecom", trimestre: "Q1", doc: "docs/recibidas/2024/Movistar_feb_2024.pdf" },
  { id: "r2024-3", fecha: "2024-03-13", prov: "Movistar", desc: "Telecom (28 Ene-27 Feb)", base: 154.87, tipoIva: 21, iva: 32.52, total: 187.39, cat: "Telecom", trimestre: "Q1", doc: "docs/recibidas/2024/Movistar_mar_2024.pdf" },
  { id: "r2024-4", fecha: "2024-01-30", prov: "iryo", desc: "Billete tren", base: 53.77, tipoIva: 10, iva: 5.38, total: 59.15, cat: "Transporte", trimestre: "Q1", doc: "docs/recibidas/2024/iryo_ene_2024.pdf" },
  { id: "r2024-5", fecha: "2024-03-07", prov: "Marcial Pons", desc: "The VC Field Guide", base: 34.46, tipoIva: 4, iva: 1.38, total: 35.84, cat: "Libros", trimestre: "Q1", doc: "docs/recibidas/2024/MarcialPons_mar_2024.pdf" },
  { id: "r2024-6", fecha: "2024-05-10", prov: "Apple Store", desc: "MacBook Pro 14\" + AppleCare + Mouse", base: 2151.24, tipoIva: 21, iva: 451.76, total: 2872.00, cat: "Equipos", trimestre: "Q2", doc: "docs/recibidas/2024/Apple_MacBook_may_2024.pdf" },
  { id: "r2024-7", fecha: "2024-05-10", prov: "Apple Store", desc: "AirPods Max", base: 478.51, tipoIva: 21, iva: 100.49, total: 579.00, cat: "Equipos", trimestre: "Q2", doc: "docs/recibidas/2024/Apple_AirPods_may_2024.pdf" },
  { id: "r2024-8", fecha: "2024-05-11", prov: "Amazon", desc: "Libro: Como innovar desde el Consejo", base: 23.08, tipoIva: 4, iva: 0.92, total: 24.00, cat: "Libros", trimestre: "Q2", doc: "docs/recibidas/2024/Amazon_libro_may_2024.pdf" },
  { id: "r2024-9", fecha: "2024-05-16", prov: "Intecat iStore", desc: "iPad Air + funda + accesorios", base: 790.12, tipoIva: 21, iva: 165.93, total: 956.05, cat: "Equipos", trimestre: "Q2", doc: "docs/recibidas/2024/Intecat_iPad_may_2024.pdf" },
  { id: "r2024-10", fecha: "2024-05-26", prov: "Amazon", desc: "Dell Monitor 31.5\" 4K Curvo", base: 338.02, tipoIva: 21, iva: 70.98, total: 409.00, cat: "Equipos", trimestre: "Q2", doc: "docs/recibidas/2024/Amazon_monitor_may_2024.pdf" },
  { id: "r2024-11", fecha: "2024-06-04", prov: "Amazon", desc: "Logitech Yeti GX Micr√≥fono", base: 95.86, tipoIva: 21, iva: 20.13, total: 115.99, cat: "Equipos", trimestre: "Q2", doc: "docs/recibidas/2024/Amazon_micro_jun_2024.pdf" },
  { id: "r2024-12", fecha: "2024-10-02", prov: "CryptoPlaza", desc: "Membership oct", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q4", doc: "docs/recibidas/2024/CryptoPlaza_oct_2024.pdf" },
  { id: "r2024-13", fecha: "2024-10-17", prov: "Marcial Pons", desc: "Bitcoinismo + Galer√≠as + Memento", base: 257.16, tipoIva: 4, iva: 10.29, total: 267.45, cat: "Libros", trimestre: "Q4", doc: "docs/recibidas/2024/MarcialPons_oct_2024.pdf" },
  { id: "r2024-14", fecha: "2024-11-04", prov: "CryptoPlaza", desc: "Membership nov", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q4", doc: "docs/recibidas/2024/CryptoPlaza_nov_2024.pdf" },
  { id: "r2024-15", fecha: "2024-11-11", prov: "Restaurante", desc: "Comida negocios", base: 72.36, tipoIva: 10, iva: 7.24, total: 79.60, cat: "Restauraci√≥n", trimestre: "Q4", doc: "docs/recibidas/2024/Restaurante_nov_2024.pdf" },
  { id: "r2024-16", fecha: "2024-11-14", prov: "TradingView", desc: "Premium anual", base: 599.40, tipoIva: 21, iva: 125.87, total: 725.27, cat: "Software", trimestre: "Q4", doc: "docs/recibidas/2024/TradingView_nov_2024.pdf" },
  { id: "r2024-17", fecha: "2024-12-03", prov: "CryptoPlaza", desc: "Membership dic", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q4", doc: "docs/recibidas/2024/CryptoPlaza_dic_2024.pdf" },
  { id: "r2024-18", fecha: "2024-10-13", prov: "Movistar", desc: "Telecom (28 Ago-27 Sep)", base: 154.87, tipoIva: 21, iva: 32.52, total: 187.39, cat: "Telecom", trimestre: "Q4", doc: "docs/recibidas/2024/Movistar_oct_2024.pdf" },
  { id: "r2024-19", fecha: "2024-11-13", prov: "Movistar", desc: "Telecom (28 Sep-27 Oct)", base: 156.13, tipoIva: 21, iva: 32.79, total: 188.91, cat: "Telecom", trimestre: "Q4", doc: "docs/recibidas/2024/Movistar_nov_2024.pdf" },
  { id: "r2024-20", fecha: "2024-12-13", prov: "Movistar", desc: "Telecom (28 Oct-27 Nov)", base: 160.72, tipoIva: 21, iva: 33.75, total: 194.47, cat: "Telecom", trimestre: "Q4", doc: "docs/recibidas/2024/Movistar_dic_2024.pdf" },
  { id: "r2024-21", fecha: "2024-12-28", prov: "MediaMarkt", desc: "2x Monitor MSI", base: 213.22, tipoIva: 21, iva: 44.78, total: 258.00, cat: "Equipos", trimestre: "Q4", doc: "docs/recibidas/2024/MediaMarkt_dic_2024.pdf" },
  { id: "r2024-22", fecha: "2024-12-31", prov: "Enrique Aznar", desc: "Servicios asesor√≠a 2024 (art.18 LIS)", base: 4402.82, tipoIva: 21, iva: 924.59, total: 4666.99, cat: "Vinculada", trimestre: "Q4", doc: "docs/recibidas/2024/EnriqueAznar_2024.pdf" },
];
const DEFAULT_RECIBIDAS_2025 = [
  { id: "r2025-1", fecha: "2025-02-13", prov: "Movistar", desc: "Telecom (28 Dic-27 Ene)", base: 158.11, tipoIva: 21, iva: 33.20, total: 191.31, cat: "Telecom", trimestre: "Q1", doc: "docs/recibidas/2025/Movistar_feb_2025.pdf" },
  { id: "r2025-2", fecha: "2025-03-13", prov: "Movistar", desc: "Telecom (28 Ene-27 Feb)", base: 169.08, tipoIva: 21, iva: 35.51, total: 204.59, cat: "Telecom", trimestre: "Q1", doc: "docs/recibidas/2025/Movistar_mar_2025.pdf" },
  { id: "r2025-3", fecha: "2025-01-03", prov: "CryptoPlaza", desc: "Membership ene", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q1", doc: "docs/recibidas/2025/CryptoPlaza_ene_2025.pdf" },
  { id: "r2025-4", fecha: "2025-04-13", prov: "Movistar", desc: "Telecom (28 Feb-27 Mar)", base: 161.56, tipoIva: 21, iva: 33.93, total: 195.49, cat: "Telecom", trimestre: "Q2", doc: "docs/recibidas/2025/Movistar_abr_2025.pdf" },
  { id: "r2025-5", fecha: "2025-04-02", prov: "CryptoPlaza", desc: "Membership abr", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q2", doc: "docs/recibidas/2025/CryptoPlaza_abr_2025.pdf" },
  { id: "r2025-6", fecha: "2025-04-03", prov: "Gamma (USA)", desc: "Gamma App abr", base: 20.00, tipoIva: 0, iva: 0, total: 20.00, cat: "Software int.", trimestre: "Q2", doc: "docs/recibidas/2025/Gamma_abr_2025.pdf" },
  { id: "r2025-7", fecha: "2025-05-13", prov: "Movistar", desc: "Telecom (28 Mar-27 Abr)", base: 168.91, tipoIva: 21, iva: 35.47, total: 204.38, cat: "Telecom", trimestre: "Q2", doc: "docs/recibidas/2025/Movistar_may_2025.pdf" },
  { id: "r2025-8", fecha: "2025-05-03", prov: "Gamma (USA)", desc: "Gamma App may", base: 20.00, tipoIva: 0, iva: 0, total: 20.00, cat: "Software int.", trimestre: "Q2", doc: "docs/recibidas/2025/Gamma_may_2025.pdf" },
  { id: "r2025-9", fecha: "2025-05-05", prov: "CryptoPlaza", desc: "Membership may", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q2", doc: "docs/recibidas/2025/CryptoPlaza_may_2025.pdf" },
  { id: "r2025-10", fecha: "2025-05-07", prov: "Logically (USA)", desc: "Unlimited Plan $10", base: 9.20, tipoIva: 0, iva: 0, total: 9.20, cat: "Software int.", trimestre: "Q2", doc: "docs/recibidas/2025/Logically_may_2025.pdf" },
  { id: "r2025-11", fecha: "2025-06-03", prov: "CryptoPlaza", desc: "Membership jun", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q2", doc: "docs/recibidas/2025/CryptoPlaza_jun_2025.pdf" },
  { id: "r2025-12", fecha: "2025-06-03", prov: "Gamma (USA)", desc: "Gamma App jun", base: 20.00, tipoIva: 0, iva: 0, total: 20.00, cat: "Software int.", trimestre: "Q2", doc: "docs/recibidas/2025/Gamma_jun_2025.pdf" },
  { id: "r2025-13", fecha: "2025-06-13", prov: "Movistar", desc: "Telecom (28 Abr-27 May)", base: 161.56, tipoIva: 21, iva: 33.93, total: 195.49, cat: "Telecom", trimestre: "Q2", doc: "docs/recibidas/2025/Movistar_jun_2025.pdf" },
  { id: "r2025-14", fecha: "2025-06-29", prov: "Anthropic (USA)", desc: "Claude Pro", base: 18.00, tipoIva: 21, iva: 3.78, total: 21.78, cat: "Software", trimestre: "Q2", doc: "docs/recibidas/2025/Anthropic_jun_2025.pdf" },
  { id: "r2025-15", fecha: "2025-07-07", prov: "Logically (USA)", desc: "Unlimited Plan $10", base: 9.20, tipoIva: 0, iva: 0, total: 9.20, cat: "Software int.", trimestre: "Q3", doc: "docs/recibidas/2025/Logically_jul_2025.pdf" },
  { id: "r2025-16", fecha: "2025-08-07", prov: "Logically (USA)", desc: "Unlimited Plan $10", base: 9.20, tipoIva: 0, iva: 0, total: 9.20, cat: "Software int.", trimestre: "Q3", doc: "docs/recibidas/2025/Logically_ago_2025.pdf" },
  { id: "r2025-17", fecha: "2025-09-07", prov: "Logically (USA)", desc: "Unlimited Plan $10", base: 9.20, tipoIva: 0, iva: 0, total: 9.20, cat: "Software int.", trimestre: "Q3" },
  { id: "r2025-18", fecha: "2025-09-20", prov: "WizzAir", desc: "Vuelo MAD-BUD/BUD-MAD", base: 145.97, tipoIva: 0, iva: 0, total: 145.97, cat: "Transporte", trimestre: "Q3", doc: "docs/recibidas/2025/WizzAir_sep_2025.pdf" },
  { id: "r2025-19", fecha: "2025-09-30", prov: "Parking Naranja", desc: "Parking Barajas", base: 22.31, tipoIva: 21, iva: 4.68, total: 26.99, cat: "Transporte", trimestre: "Q3", doc: "docs/recibidas/2025/Parking_sep_2025.pdf" },
  { id: "r2025-20", fecha: "2025-10-02", prov: "CryptoPlaza", desc: "Membership oct", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q4", doc: "docs/recibidas/2025/CryptoPlaza_oct_2025.pdf" },
  { id: "r2025-21", fecha: "2025-10-05", prov: "Intermodalidad Levante", desc: "Billete tren", base: 62.08, tipoIva: 10, iva: 6.21, total: 68.29, cat: "Transporte", trimestre: "Q4", doc: "docs/recibidas/2025/Intermodalidad_oct_2025.pdf" },
  { id: "r2025-22", fecha: "2025-10-07", prov: "Logically (USA)", desc: "Unlimited Plan $10", base: 9.20, tipoIva: 0, iva: 0, total: 9.20, cat: "Software int.", trimestre: "Q4" },
  { id: "r2025-23", fecha: "2025-11-04", prov: "CryptoPlaza", desc: "Membership nov", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q4", doc: "docs/recibidas/2025/CryptoPlaza_nov_2025.pdf" },
  { id: "r2025-24", fecha: "2025-11-13", prov: "Movistar", desc: "Telecom (28 Sep-27 Oct)", base: 315.13, tipoIva: 21, iva: 66.18, total: 381.31, cat: "Telecom", trimestre: "Q4", doc: "docs/recibidas/2025/Movistar_nov_2025.pdf" },
  { id: "r2025-25", fecha: "2025-11-16", prov: "Intermodalidad Levante", desc: "Billete tren", base: 41.28, tipoIva: 10, iva: 4.13, total: 45.41, cat: "Transporte", trimestre: "Q4", doc: "docs/recibidas/2025/Intermodalidad_nov_2025.pdf" },
  { id: "r2025-26", fecha: "2025-12-02", prov: "CryptoPlaza", desc: "Membership dic", base: 20.66, tipoIva: 21, iva: 4.34, total: 25.00, cat: "Suscripciones", trimestre: "Q4", doc: "docs/recibidas/2025/CryptoPlaza_dic_2025.pdf" },
  { id: "r2025-27", fecha: "2025-12-04", prov: "Intermodalidad Levante", desc: "Billete tren", base: 56.85, tipoIva: 10, iva: 5.68, total: 62.53, cat: "Transporte", trimestre: "Q4", doc: "docs/recibidas/2025/Intermodalidad_dic_2025.pdf" },
  { id: "r2025-28", fecha: "2025-12-11", prov: "Ambar Partners", desc: "Community Builder anual", base: 288.00, tipoIva: 21, iva: 60.48, total: 348.48, cat: "Suscripciones", trimestre: "Q4", doc: "docs/recibidas/2025/AmbarPartners_dic_2025.pdf" },
  { id: "r2025-29", fecha: "2025-12-13", prov: "Movistar", desc: "Telecom (28 Oct-27 Nov)", base: 164.69, tipoIva: 21, iva: 34.58, total: 199.27, cat: "Telecom", trimestre: "Q4", doc: "docs/recibidas/2025/Movistar_dic_2025.pdf" },
  { id: "r2025-30", fecha: "2025-12-31", prov: "Enrique Aznar", desc: "Servicios asesor√≠a 2025 (art.18 LIS)", base: 9620.00, tipoIva: 21, iva: 2020.20, total: 10197.20, cat: "Vinculada", trimestre: "Q4", doc: "docs/recibidas/2025/EnriqueAznar_2025.pdf" },
];
const ALERTAS = [
  { tipo: "warning", msg: "Faltan facturas Movistar: Abr-Sep 2024 y Ene, Jul-Oct 2025", accion: "Descargar de Mi Movistar" },
  { tipo: "warning", msg: "CryptoPlaza: faltan Feb, Mar, Jul, Ago, Sep 2025", accion: "Solicitar a Sky Media Group" },
  { tipo: "error", msg: "Invoice 2/2024 y 3/2024 duplicadas (Rivera del Campo)", accion: "Confirmar si son 1 o 2 facturas" },
  { tipo: "error", msg: "WizzAir: factura a Sunblock Urban Token, no Aznar Legal", accion: "No deducible salvo refacturaci√≥n" },
  { tipo: "info", msg: "Logically en USD: pendiente tipo de cambio BCE", accion: "Aplicar TC oficial" },
  { tipo: "info", msg: "Gamma/Logically/Anthropic: posible inversi√≥n sujeto pasivo", accion: "Autorrepercutir IVA en Mod.303" },
  { tipo: "warning", msg: "Restaurante: factura proforma, no v√°lida para IVA", accion: "Solicitar factura completa" },
];

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
const fmt = n => n.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
const fmtDate = d => { if(!d) return ""; const p=d.split("-"); return p[2]+"/"+p[1]+"/"+p[0]; };
const toISO = d => { if(!d||d.includes("-")) return d; const p=d.split("/"); return p[2]+"-"+p[1]+"-"+p[0]; };
const sum = (arr,key) => arr.reduce((s,r)=>s+(r[key]||0),0);
const getQ = fecha => { const m=parseInt(fecha.split("-")[1]); if(m<=3) return "Q1"; if(m<=6) return "Q2"; if(m<=9) return "Q3"; return "Q4"; };
const genId = () => "id-"+Date.now()+"-"+Math.random().toString(36).substr(2,5);
const calcIva = (base,tipo) => Math.round(base*tipo/100*100)/100;

function loadData(key, def) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : def; } catch(e) { return def; } }
function saveData(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {} }

function exportCSV(data, filename, cols) {
  const header = cols.map(c=>c.label).join(";");
  const rows = data.map(r => cols.map(c => { let v = c.key ? r[c.key] : (c.get ? c.get(r) : ""); if(typeof v==="number") v=v.toString().replace(".",","); return '"'+String(v).replace(/"/g,'""')+'"'; }).join(";"));
  const csv = "\uFEFF"+header+"\n"+rows.join("\n");
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ SHARED COMPONENTS ‚îÄ‚îÄ‚îÄ
const Badge = ({type,children}) => {
  const c = {warning:{bg:"#FEF9E7",text:"#7D6608",b:"#F9E79F"},error:{bg:"#FDEDEC",text:"#922B21",b:"#F5B7B1"},info:{bg:"#EAF2F8",text:"#1A5276",b:"#AED6F1"},success:{bg:"#EAFAF1",text:"#1E8449",b:"#A9DFBF"}}[type]||{bg:"#EAF2F8",text:"#1A5276",b:"#AED6F1"};
  return <span style={{background:c.bg,color:c.text,padding:"2px 8px",borderRadius:4,fontSize:10,fontWeight:600,border:`1px solid ${c.b}`}}>{children}</span>;
};
const KPI = ({label,value,sub,color,onClick}) => (
  <div onClick={onClick} style={{background:"#fff",borderRadius:10,padding:"16px 20px",flex:1,minWidth:160,border:"1px solid #E4E9F0",boxShadow:"0 1px 3px rgba(0,0,0,0.04)",cursor:onClick?"pointer":"default"}}>
    <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:6,fontWeight:700}}>{label}</div>
    <div style={{color:color||"#2E6B3A",fontSize:20,fontWeight:700,fontFamily:"monospace"}}>{value}</div>
    {sub&&<div style={{color:"#A0AEBB",fontSize:11,marginTop:3}}>{sub}</div>}
  </div>
);
const NavItem = ({icon,label,active,onClick,badge}) => (
  <button onClick={onClick} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 20px",width:"100%",background:active?"#EBF2EB":"transparent",border:"none",cursor:"pointer",color:active?"#2E6B3A":"#7A8DA0",fontSize:13,fontFamily:"system-ui",borderLeft:active?"3px solid #3D7A4A":"3px solid transparent",borderRadius:"0 6px 6px 0",textAlign:"left",fontWeight:active?600:400,transition:"all 0.15s"}}>
    <span style={{fontSize:15,width:20,textAlign:"center"}}>{icon}</span>
    <span style={{flex:1}}>{label}</span>
    {badge!=null&&<span style={{background:"#3D7A4A",color:"#fff",borderRadius:10,padding:"1px 7px",fontSize:10,fontWeight:700}}>{badge}</span>}
  </button>
);

// ‚îÄ‚îÄ‚îÄ MODAL FORM: EMITIDA ‚îÄ‚îÄ‚îÄ
function ModalEmitida({item, onSave, onClose}) {
  const [f, setF] = useState(item || {num:"",fecha:"",cliente:"",nif:"",desc:"",base:0,tipoIva:21});
  const upd = (k,v) => setF({...f,[k]:v});
  const save = () => {
    const base = parseFloat(f.base)||0;
    const tipoIva = parseFloat(f.tipoIva)||0;
    const iva = calcIva(base,tipoIva);
    const total = base+iva;
    const trimestre = getQ(f.fecha);
    onSave({...f, id:f.id||genId(), base, tipoIva, iva, total, trimestre});
  };
  return <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>{item?"Editar":"Nueva"} Factura Emitida</h3>
    <div className="form-row">
      <div className="form-group"><label>N¬∫ Factura</label><input value={f.num} onChange={e=>upd("num",e.target.value)} placeholder="1/2025"/></div>
      <div className="form-group"><label>Fecha</label><input type="date" value={f.fecha} onChange={e=>upd("fecha",e.target.value)}/></div>
    </div>
    <div className="form-row">
      <div className="form-group"><label>Cliente</label><input value={f.cliente} onChange={e=>upd("cliente",e.target.value)}/></div>
      <div className="form-group"><label>NIF</label><input value={f.nif} onChange={e=>upd("nif",e.target.value)}/></div>
    </div>
    <div className="form-row">
      <div className="form-group" style={{flex:3}}><label>Descripci√≥n</label><input value={f.desc} onChange={e=>upd("desc",e.target.value)}/></div>
    </div>
    <div className="form-row">
      <div className="form-group" style={{flex:3}}><label>Ruta documento (relativa, ej: docs/emitidas/2025/mi_factura.pdf)</label><input value={f.doc||""} onChange={e=>upd("doc",e.target.value)} placeholder="docs/emitidas/2025/..."/></div>
    </div>
    <div className="form-row">
      <div className="form-group"><label>Base imponible (‚Ç¨)</label><input type="number" step="0.01" value={f.base} onChange={e=>upd("base",e.target.value)}/></div>
      <div className="form-group"><label>Tipo IVA (%)</label><select value={f.tipoIva} onChange={e=>upd("tipoIva",parseFloat(e.target.value))}><option value={21}>21%</option><option value={10}>10%</option><option value={4}>4%</option><option value={0}>0% (exento)</option></select></div>
      <div className="form-group"><label>IVA</label><div style={{padding:"8px 0",fontFamily:"monospace",fontSize:13}}>{fmt(calcIva(parseFloat(f.base)||0,parseFloat(f.tipoIva)||0))}</div></div>
      <div className="form-group"><label>Total</label><div style={{padding:"8px 0",fontFamily:"monospace",fontSize:13,fontWeight:700,color:"#2E6B3A"}}>{fmt((parseFloat(f.base)||0)+calcIva(parseFloat(f.base)||0,parseFloat(f.tipoIva)||0))}</div></div>
    </div>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16}}>
      <button className="btn btn-secondary" onClick={onClose}>Cancelar</button>
      <button className="btn btn-primary" onClick={save}>Guardar</button>
    </div>
  </div></div>;
}

// ‚îÄ‚îÄ‚îÄ MODAL FORM: RECIBIDA ‚îÄ‚îÄ‚îÄ
function ModalRecibida({item, onSave, onClose}) {
  const cats = ["Telecom","Equipos","Software","Software int.","Suscripciones","Libros","Transporte","Restauraci√≥n","Vinculada","Otros"];
  const [f, setF] = useState(item || {fecha:"",prov:"",desc:"",base:0,tipoIva:21,cat:"Otros"});
  const upd = (k,v) => setF({...f,[k]:v});
  const save = () => {
    const base = parseFloat(f.base)||0;
    const tipoIva = parseFloat(f.tipoIva)||0;
    const iva = calcIva(base,tipoIva);
    const total = base+iva;
    const trimestre = getQ(f.fecha);
    onSave({...f, id:f.id||genId(), base, tipoIva, iva, total, trimestre});
  };
  return <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>{item?"Editar":"Nueva"} Factura Recibida</h3>
    <div className="form-row">
      <div className="form-group"><label>Fecha</label><input type="date" value={f.fecha} onChange={e=>upd("fecha",e.target.value)}/></div>
      <div className="form-group"><label>Proveedor</label><input value={f.prov} onChange={e=>upd("prov",e.target.value)}/></div>
      <div className="form-group"><label>Categor√≠a</label><select value={f.cat} onChange={e=>upd("cat",e.target.value)}>{cats.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
    </div>
    <div className="form-row">
      <div className="form-group" style={{flex:3}}><label>Descripci√≥n</label><input value={f.desc} onChange={e=>upd("desc",e.target.value)}/></div>
    </div>
    <div className="form-row">
      <div className="form-group" style={{flex:3}}><label>Ruta documento (relativa, ej: docs/recibidas/2025/factura.pdf)</label><input value={f.doc||""} onChange={e=>upd("doc",e.target.value)} placeholder="docs/recibidas/2025/..."/></div>
    </div>
    <div className="form-row">
      <div className="form-group"><label>Base imponible (‚Ç¨)</label><input type="number" step="0.01" value={f.base} onChange={e=>upd("base",e.target.value)}/></div>
      <div className="form-group"><label>Tipo IVA (%)</label><select value={f.tipoIva} onChange={e=>upd("tipoIva",parseFloat(e.target.value))}><option value={21}>21%</option><option value={10}>10%</option><option value={4}>4%</option><option value={0}>0% (exento/no sujeto)</option></select></div>
      <div className="form-group"><label>IVA</label><div style={{padding:"8px 0",fontFamily:"monospace",fontSize:13}}>{fmt(calcIva(parseFloat(f.base)||0,parseFloat(f.tipoIva)||0))}</div></div>
      <div className="form-group"><label>Total</label><div style={{padding:"8px 0",fontFamily:"monospace",fontSize:13,fontWeight:700,color:"#C0392B"}}>{fmt((parseFloat(f.base)||0)+calcIva(parseFloat(f.base)||0,parseFloat(f.tipoIva)||0))}</div></div>
    </div>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16}}>
      <button className="btn btn-secondary" onClick={onClose}>Cancelar</button>
      <button className="btn btn-primary" onClick={save}>Guardar</button>
    </div>
  </div></div>;
}

// ‚îÄ‚îÄ‚îÄ CONFIRM DIALOG ‚îÄ‚îÄ‚îÄ
function ConfirmDialog({msg, onYes, onNo}) {
  return <div className="modal-overlay" onClick={onNo}><div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:400}}>
    <h3 style={{color:"#C0392B"}}>Confirmar</h3>
    <p style={{margin:"12px 0 20px",fontSize:14,color:"#2C3E50"}}>{msg}</p>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
      <button className="btn btn-secondary" onClick={onNo}>Cancelar</button>
      <button className="btn btn-danger" onClick={onYes}>Eliminar</button>
    </div>
  </div></div>;
}

// ‚îÄ‚îÄ‚îÄ DATA TABLE ‚îÄ‚îÄ‚îÄ
const DataTable = ({columns,data,maxH,onEdit,onDelete}) => (
  <div style={{overflowX:"auto",overflowY:maxH?"auto":"visible",maxHeight:maxH,borderRadius:8,border:"1px solid #E4E9F0",background:"#fff"}}>
    <table style={{width:"100%",borderCollapse:"collapse",fontSize:12,fontFamily:"system-ui"}}>
      <thead><tr>
        {columns.map((c,i)=><th key={i} style={{padding:"10px 12px",textAlign:c.align||"left",color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:0.8,borderBottom:"2px solid #3D7A4A",background:"#FAFBFC",position:"sticky",top:0,whiteSpace:"nowrap",fontWeight:700}}>{c.label}</th>)}
        {(onEdit||onDelete)&&<th style={{padding:"10px 12px",textAlign:"center",color:"#7A8DA0",fontSize:10,textTransform:"uppercase",borderBottom:"2px solid #3D7A4A",background:"#FAFBFC",position:"sticky",top:0,fontWeight:700,width:90}}>Acciones</th>}
      </tr></thead>
      <tbody>{data.map((row,ri)=><tr key={row.id||ri} onMouseEnter={e=>e.currentTarget.style.background="#F7F9F7"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
        {columns.map((c,ci)=><td key={ci} style={{padding:"8px 12px",color:c.color||"#2C3E50",borderBottom:"1px solid #F0F2F5",textAlign:c.align||"left",whiteSpace:c.nowrap?"nowrap":"normal",fontFamily:c.mono?"monospace":"system-ui",fontWeight:c.bold?600:400,fontSize:c.mono?11:12}}>{c.render?c.render(row):row[c.key]}</td>)}
        {(onEdit||onDelete)&&<td style={{padding:"8px 6px",borderBottom:"1px solid #F0F2F5",textAlign:"center",whiteSpace:"nowrap"}}>
          {onEdit&&<button className="btn btn-sm btn-secondary" style={{marginRight:4}} onClick={()=>onEdit(row)}>‚úèÔ∏è</button>}
          {onDelete&&<button className="btn btn-sm btn-danger" onClick={()=>onDelete(row)}>üóë</button>}
        </td>}
      </tr>)}</tbody>
    </table>
  </div>
);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê  MAIN APP  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function App() {
  const [section, setSection] = useState("dashboard");
  const [year, setYear] = useState(2025);
  const [sideOpen, setSideOpen] = useState(true);
  const [search, setSearch] = useState("");

  // ‚îÄ‚îÄ‚îÄ PERSISTENT DATA ‚îÄ‚îÄ‚îÄ
  const [emitidas2023, setEmitidas2023] = useState(()=>loadData("emitidas_2023", []));
  const [emitidas2024, setEmitidas2024] = useState(()=>loadData("emitidas_2024", DEFAULT_EMITIDAS_2024));
  const [emitidas2025, setEmitidas2025] = useState(()=>loadData("emitidas_2025", DEFAULT_EMITIDAS_2025));
  const [recibidas2023, setRecibidas2023] = useState(()=>loadData("recibidas_2023", []));
  const [recibidas2024, setRecibidas2024] = useState(()=>loadData("recibidas_2024", DEFAULT_RECIBIDAS_2024));
  const [recibidas2025, setRecibidas2025] = useState(()=>loadData("recibidas_2025", DEFAULT_RECIBIDAS_2025));

  useEffect(()=>saveData("emitidas_2023",emitidas2023),[emitidas2023]);
  useEffect(()=>saveData("emitidas_2024",emitidas2024),[emitidas2024]);
  useEffect(()=>saveData("emitidas_2025",emitidas2025),[emitidas2025]);
  useEffect(()=>saveData("recibidas_2023",recibidas2023),[recibidas2023]);
  useEffect(()=>saveData("recibidas_2024",recibidas2024),[recibidas2024]);
  useEffect(()=>saveData("recibidas_2025",recibidas2025),[recibidas2025]);

  const emitidas = year===2023?emitidas2023:year===2024?emitidas2024:emitidas2025;
  const setEmitidas = year===2023?setEmitidas2023:year===2024?setEmitidas2024:setEmitidas2025;
  const recibidas = year===2023?recibidas2023:year===2024?recibidas2024:recibidas2025;
  const setRecibidas = year===2023?setRecibidas2023:year===2024?setRecibidas2024:setRecibidas2025;

  // ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ
  const [modalEmitida, setModalEmitida] = useState(null); // null=closed, {}=new, {data}=edit
  const [modalRecibida, setModalRecibida] = useState(null);
  const [confirmDelete, setConfirmDelete] = useState(null); // {type,item}

  // ‚îÄ‚îÄ‚îÄ CRUD EMITIDAS ‚îÄ‚îÄ‚îÄ
  const saveEmitida = (item) => {
    setEmitidas(prev => { const idx=prev.findIndex(x=>x.id===item.id); if(idx>=0){ const n=[...prev]; n[idx]=item; return n; } return [...prev,item]; });
    setModalEmitida(null);
  };
  const deleteEmitida = (item) => { setEmitidas(prev=>prev.filter(x=>x.id!==item.id)); setConfirmDelete(null); };

  // ‚îÄ‚îÄ‚îÄ CRUD RECIBIDAS ‚îÄ‚îÄ‚îÄ
  const saveRecibida = (item) => {
    setRecibidas(prev => { const idx=prev.findIndex(x=>x.id===item.id); if(idx>=0){ const n=[...prev]; n[idx]=item; return n; } return [...prev,item]; });
    setModalRecibida(null);
  };
  const deleteRecibida = (item) => { setRecibidas(prev=>prev.filter(x=>x.id!==item.id)); setConfirmDelete(null); };

  // ‚îÄ‚îÄ‚îÄ AGGREGATES ‚îÄ‚îÄ‚îÄ
  const tIB=sum(emitidas,"base"), tIR=sum(emitidas,"iva");
  const tGB=sum(recibidas,"base"), tGI=sum(recibidas,"iva");
  const resultado=tIB-tGB, ivaNet=tIR-tGI;
  const qd=["Q1","Q2","Q3","Q4"].map(q=>({q,iR:sum(emitidas.filter(e=>e.trimestre===q),"iva"),iS:sum(recibidas.filter(r=>r.trimestre===q),"iva"),bE:sum(emitidas.filter(e=>e.trimestre===q),"base"),bR:sum(recibidas.filter(r=>r.trimestre===q),"base")}));
  const catD={}; recibidas.forEach(r=>{catD[r.cat]=(catD[r.cat]||0)+r.base;}); const catS=Object.entries(catD).sort((a,b)=>b[1]-a[1]);
  const maxC=catS[0]?.[1]||1;
  const cc=["#3D7A4A","#2980B9","#27AE60","#E67E22","#8E44AD","#C0392B","#16A085","#D4AC0D"];

  const sections = {dashboard:"Panel de Control",emitidas:"Facturas Emitidas",recibidas:"Facturas Recibidas",iva:"IVA ‚Äî Modelo 303",is:"Impuesto sobre Sociedades",alertas:"Alertas y Gaps",docs:"Documentos Fiscales"};

  // ‚îÄ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ‚îÄ
  const filteredEmitidas = emitidas.filter(e => !search || [e.num,e.cliente,e.desc,e.nif].some(s=>(s||"").toLowerCase().includes(search.toLowerCase())));
  const filteredRecibidas = recibidas.filter(r => !search || [r.prov,r.desc,r.cat].some(s=>(s||"").toLowerCase().includes(search.toLowerCase())));

  // ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ
  const exportEmitidas = () => exportCSV(emitidas, `emitidas_${year}.csv`, [
    {label:"N¬∫",key:"num"},{label:"Fecha",key:"fecha",get:r=>fmtDate(r.fecha)},{label:"Cliente",key:"cliente"},{label:"NIF",key:"nif"},{label:"Descripci√≥n",key:"desc"},{label:"Base",key:"base"},{label:"Tipo IVA",key:"tipoIva"},{label:"IVA",key:"iva"},{label:"Total",key:"total"},{label:"Trimestre",key:"trimestre"}
  ]);
  const exportRecibidas = () => exportCSV(recibidas, `recibidas_${year}.csv`, [
    {label:"Fecha",key:"fecha",get:r=>fmtDate(r.fecha)},{label:"Proveedor",key:"prov"},{label:"Descripci√≥n",key:"desc"},{label:"Base",key:"base"},{label:"Tipo IVA",key:"tipoIva"},{label:"IVA",key:"iva"},{label:"Total",key:"total"},{label:"Categor√≠a",key:"cat"},{label:"Trimestre",key:"trimestre"}
  ]);

  // ‚îÄ‚îÄ‚îÄ RENDER SECTIONS ‚îÄ‚îÄ‚îÄ
  const renderSection = () => {
    if(section==="dashboard") return <div style={{display:"flex",flexDirection:"column",gap:18}}>
      <div style={{display:"flex",gap:14,flexWrap:"wrap"}}>
        <KPI label="Ingresos" value={fmt(tIB)} sub={`${emitidas.length} facturas`} onClick={()=>setSection("emitidas")}/>
        <KPI label="Gastos" value={fmt(tGB)} sub={`${recibidas.length} facturas`} color="#C0392B" onClick={()=>setSection("recibidas")}/>
        <KPI label="Resultado" value={fmt(resultado)} color={resultado>=0?"#27AE60":"#C0392B"} sub={resultado>=0?"Beneficio":"P√©rdida"} onClick={()=>setSection("is")}/>
        <KPI label="IVA neto" value={fmt(ivaNet)} color={ivaNet>=0?"#C0392B":"#27AE60"} sub={ivaNet>=0?"A ingresar":"A compensar"} onClick={()=>setSection("iva")}/>
      </div>
      <div style={{display:"flex",gap:16,flexWrap:"wrap"}}>
        <div style={{flex:2,minWidth:300,background:"#fff",borderRadius:10,padding:20,border:"1px solid #E4E9F0"}}>
          <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>IVA por trimestre</div>
          {qd.map((q,i)=><div key={i} style={{marginBottom:14}}>
            <div style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#2C3E50",marginBottom:4}}>
              <span style={{fontWeight:700}}>{q.q}</span>
              <span style={{fontFamily:"monospace",fontSize:11}}>Rep: {fmt(q.iR)} ¬∑ Sop: {fmt(q.iS)} ¬∑ <span style={{color:q.iR-q.iS>=0?"#C0392B":"#27AE60",fontWeight:700}}>{fmt(q.iR-q.iS)}</span></span>
            </div>
            <div style={{display:"flex",gap:3,height:10,borderRadius:5,overflow:"hidden",background:"#F0F2F5"}}>
              <div style={{width:`${Math.max(4,(q.iR/Math.max(tIR,1))*100)}%`,background:"#3D7A4A",borderRadius:5}}/>
              <div style={{width:`${Math.max(4,(q.iS/Math.max(tGI,1))*100)}%`,background:"#A9DFBF",borderRadius:5}}/>
            </div>
          </div>)}
        </div>
        <div style={{flex:1,minWidth:240,background:"#fff",borderRadius:10,padding:20,border:"1px solid #E4E9F0"}}>
          <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Gastos por categor√≠a</div>
          {catS.map(([cat,val],i)=><div key={i} style={{marginBottom:10}}>
            <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:"#2C3E50",marginBottom:3}}><span>{cat}</span><span style={{fontFamily:"monospace",fontWeight:600,color:"#3D7A4A"}}>{fmt(val)}</span></div>
            <div style={{height:6,borderRadius:3,background:"#F0F2F5"}}><div style={{width:`${(val/maxC)*100}%`,height:"100%",borderRadius:3,background:cc[i%cc.length]}}/></div>
          </div>)}
        </div>
      </div>
      <div style={{background:"#fff",borderRadius:10,padding:20,border:"1px solid #E4E9F0",cursor:"pointer"}} onClick={()=>setSection("alertas")}>
        <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:12,fontWeight:700}}>Alertas ({ALERTAS.length}) ‚Äî clic para ver detalle</div>
        {ALERTAS.slice(0,3).map((a,i)=><div key={i} style={{display:"flex",gap:10,alignItems:"center",padding:"6px 0",fontSize:12,color:"#2C3E50"}}><Badge type={a.tipo}>{a.tipo}</Badge><span>{a.msg}</span></div>)}
        {ALERTAS.length>3&&<div style={{fontSize:11,color:"#7A8DA0",marginTop:6}}>+{ALERTAS.length-3} m√°s...</div>}
      </div>
    </div>;

    if(section==="emitidas") return <div>
      <div style={{display:"flex",gap:14,marginBottom:18,flexWrap:"wrap"}}>
        <KPI label="Total facturado" value={fmt(tIB)} sub={`${emitidas.length} facturas`}/>
        <KPI label="IVA repercutido" value={fmt(tIR)} color="#2980B9"/>
        <KPI label="Exentas / No sujetas" value={fmt(sum(emitidas.filter(e=>e.tipoIva===0),"base"))} color="#8E44AD" sub="Art.20.9, 20.1.10¬∫, 69"/>
      </div>
      <div className="action-bar no-print">
        <button className="btn btn-primary" onClick={()=>setModalEmitida({})}>+ Nueva factura</button>
        <button className="btn btn-export" onClick={exportEmitidas}>‚Üì Exportar CSV</button>
        <div style={{flex:1}}/>
        <input className="search-input" placeholder="Buscar por n¬∫, cliente, desc..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      <DataTable maxH={420} columns={[
        {label:"N¬∫",key:"num",nowrap:true,bold:true},
        {label:"Fecha",render:r=>fmtDate(r.fecha),nowrap:true},
        {label:"Cliente",key:"cliente"},
        {label:"Descripci√≥n",key:"desc"},
        {label:"Base",align:"right",mono:true,render:r=>fmt(r.base)},
        {label:"IVA%",align:"center",render:r=>r.tipoIva?`${r.tipoIva}%`:<Badge type="info">exento</Badge>},
        {label:"IVA",align:"right",mono:true,render:r=>r.iva?fmt(r.iva):"‚Äî"},
        {label:"Total",align:"right",mono:true,bold:true,color:"#2E6B3A",render:r=>fmt(r.total)},
        {label:"T",key:"trimestre",align:"center",nowrap:true},
        {label:"PDF",align:"center",render:r=>r.doc?<a href={r.doc} target="_blank" rel="noopener" style={{color:"#2980B9",textDecoration:"none",fontWeight:700,fontSize:14}} title="Ver factura">üìÑ</a>:<span style={{color:"#ccc"}}>‚Äî</span>},
      ]} data={filteredEmitidas} onEdit={item=>setModalEmitida(item)} onDelete={item=>setConfirmDelete({type:"emitida",item})}/>
    </div>;

    if(section==="recibidas") return <div>
      <div style={{display:"flex",gap:14,marginBottom:18,flexWrap:"wrap"}}>
        <KPI label="Total gastos" value={fmt(tGB)} sub={`${recibidas.length} facturas`} color="#C0392B"/>
        <KPI label="IVA soportado" value={fmt(tGI)} color="#2980B9"/>
        <KPI label="Mayor gasto" value={catS[0]?.[0]||"‚Äî"} sub={catS[0]?fmt(catS[0][1]):""} color="#E67E22"/>
      </div>
      <div className="action-bar no-print">
        <button className="btn btn-primary" onClick={()=>setModalRecibida({})}>+ Nueva factura</button>
        <button className="btn btn-export" onClick={exportRecibidas}>‚Üì Exportar CSV</button>
        <div style={{flex:1}}/>
        <input className="search-input" placeholder="Buscar por proveedor, desc, categor√≠a..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      <DataTable maxH={420} columns={[
        {label:"Fecha",render:r=>fmtDate(r.fecha),nowrap:true},
        {label:"Proveedor",key:"prov"},
        {label:"Descripci√≥n",key:"desc"},
        {label:"Base",align:"right",mono:true,render:r=>fmt(r.base)},
        {label:"IVA%",align:"center",render:r=>r.tipoIva?`${r.tipoIva}%`:"‚Äî"},
        {label:"IVA",align:"right",mono:true,render:r=>r.iva?fmt(r.iva):"‚Äî"},
        {label:"Total",align:"right",mono:true,bold:true,color:"#C0392B",render:r=>fmt(r.total)},
        {label:"Cat.",render:r=><Badge type={r.cat==="Vinculada"?"warning":r.cat==="Equipos"?"success":"info"}>{r.cat}</Badge>},
        {label:"T",key:"trimestre",align:"center",nowrap:true},
        {label:"PDF",align:"center",render:r=>r.doc?<a href={r.doc} target="_blank" rel="noopener" style={{color:"#2980B9",textDecoration:"none",fontWeight:700,fontSize:14}} title="Ver factura">üìÑ</a>:<span style={{color:"#ccc"}}>‚Äî</span>},
      ]} data={filteredRecibidas} onEdit={item=>setModalRecibida(item)} onDelete={item=>setConfirmDelete({type:"recibida",item})}/>
    </div>;

    if(section==="iva") return <div>
      <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Modelo 303 ‚Äî Liquidaci√≥n trimestral IVA {year}</div>
      <DataTable columns={[
        {label:"Trimestre",key:"q",bold:true},
        {label:"Base Emitidas",align:"right",mono:true,render:r=>fmt(r.bE)},
        {label:"IVA Repercutido",align:"right",mono:true,color:"#3D7A4A",render:r=>fmt(r.iR)},
        {label:"Base Recibidas",align:"right",mono:true,render:r=>fmt(r.bR)},
        {label:"IVA Soportado",align:"right",mono:true,color:"#2980B9",render:r=>fmt(r.iS)},
        {label:"Resultado",align:"right",mono:true,bold:true,render:r=>{const v=r.iR-r.iS;return <span style={{color:v>=0?"#C0392B":"#27AE60"}}>{fmt(v)}</span>;}},
      ]} data={[...qd,{q:"TOTAL",bE:tIB,iR:tIR,bR:tGB,iS:tGI,id:"total"}]}/>
      <div style={{marginTop:18,background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0"}}>
        <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:8,fontWeight:700}}>Notas IVA</div>
        <div style={{fontSize:12,color:"#2C3E50",lineHeight:1.8}}>‚Ä¢ Cr√©dito IVA acumulado ~11.597‚Ç¨<br/>‚Ä¢ Exentas art.20.9/20.1.10¬∫<br/>‚Ä¢ Art.69 (Vergara): no sujetas<br/>‚Ä¢ USA (Gamma, Logically): inversi√≥n sujeto pasivo 12-13<br/>‚Ä¢ Faltan meses Movistar</div>
      </div>
    </div>;

    if(section==="is") return <div>
      <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Impuesto sobre Sociedades ‚Äî Estimaci√≥n {year}</div>
      <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden"}}>
        {[
          {l:"Ingresos de explotaci√≥n",v:tIB,b:true},
          ...emitidas.reduce((a,e)=>{const x=a.find(i=>i.l===e.cliente);if(x)x.v+=e.base;else a.push({l:e.cliente,v:e.base,i:1});return a;},[]),
          {l:"Gastos de explotaci√≥n",v:-tGB,b:true,c:"#C0392B"},
          ...catS.map(([cat,val])=>({l:cat,v:-val,i:1,c:"#C0392B"})),
          {l:"RESULTADO ANTES DE IMPUESTOS",v:resultado,b:true,c:resultado>=0?"#27AE60":"#C0392B",sep:true},
          {l:"Tipo IS (25%)",v:null},
          {l:"Cuota IS estimada",v:resultado>0?resultado*0.25:0,b:true,c:"#3D7A4A"},
        ].map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"10px 20px",paddingLeft:20+(r.i||0)*24,borderTop:r.sep?"2px solid #3D7A4A":i>0?"1px solid #F0F2F5":"none",background:r.b&&!r.i?"#FAFBFC":"#fff"}}>
          <span style={{fontSize:12,color:r.b?"#2C3E50":"#7A8DA0",fontWeight:r.b?700:400}}>{r.l}</span>
          <span style={{fontSize:12,fontFamily:"monospace",color:r.c||"#2C3E50",fontWeight:r.b?700:400}}>{r.v!=null?fmt(Math.abs(r.v)):""}</span>
        </div>)}
      </div>
    </div>;

    if(section==="alertas") return <div>
      <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Alertas y gaps detectados</div>
      {ALERTAS.map((a,i)=><div key={i} style={{display:"flex",gap:10,alignItems:"flex-start",padding:"12px 16px",borderRadius:8,marginBottom:8,background:a.tipo==="error"?"#FDEDEC":a.tipo==="warning"?"#FEF9E7":"#EAF2F8",border:`1px solid ${a.tipo==="error"?"#F5B7B1":a.tipo==="warning"?"#F9E79F":"#AED6F1"}`}}>
        <Badge type={a.tipo}>{a.tipo}</Badge>
        <div style={{flex:1,fontSize:13,color:"#2C3E50"}}>{a.msg}</div>
        <div style={{fontSize:12,color:"#7A8DA0",minWidth:160,textAlign:"right",fontStyle:"italic"}}>{a.accion}</div>
      </div>)}
    </div>;

    if(section==="docs") return <div>
      <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Documentos fiscales y corporativos</div>
      <DataTable maxH={480} columns={[
        {label:"Tipo",key:"tipo",bold:true},
        {label:"Archivo",render:r=>r.doc?<a href={r.doc} target="_blank" rel="noopener" style={{color:"#2980B9",fontSize:11,textDecoration:"none"}}>{r.archivo} üìÑ</a>:<span style={{color:"#999",fontSize:11}}>{r.archivo}</span>},
        {label:"Descripci√≥n",key:"desc"},
        {label:"Periodo",key:"periodo",nowrap:true},
      ]} data={[
        {id:"d1",tipo:"IVA 303",archivo:"IVA_Q3_2024.pdf",desc:"Modelo 303 3T 2024",periodo:"Q3 2024",doc:"docs/fiscal/IVA_Q3_2024.pdf"},
        {id:"d2",tipo:"IVA 303",archivo:"IVA_Q4_2024.pdf",desc:"Modelo 303 4T 2024",periodo:"Q4 2024",doc:"docs/fiscal/IVA_Q4_2024.pdf"},
        {id:"d3",tipo:"IVA 390",archivo:"IVA_resumen_anual_2024.pdf",desc:"Resumen anual IVA",periodo:"2024",doc:"docs/fiscal/IVA_resumen_anual_2024.pdf"},
        {id:"d4",tipo:"IVA",archivo:"IVA_2T2024.xlsx",desc:"Borrador IVA 2T",periodo:"Q2 2024",doc:"docs/fiscal/IVA_2T2024.xlsx"},
        {id:"d5",tipo:"IS",archivo:"Justificante_pago_a_cuenta.pdf",desc:"Pago a cuenta IS",periodo:"2024",doc:"docs/fiscal/Justificante_pago_a_cuenta_IS_22024.pdf"},
        {id:"d6",tipo:"IS",archivo:"Liquidacion_pago_cuenta.pdf",desc:"Liquidaci√≥n IS",periodo:"2024",doc:"docs/fiscal/Liquidacio_n_Pago_a_cuenta_IS_2024.pdf"},
        {id:"d7",tipo:"AEAT",archivo:"Mod.010 ‚Äî 248,22‚Ç¨",desc:"Pago Mod.010",periodo:"Ene 2026",doc:"docs/fiscal/082615305105DC5LNA45CZ.pdf"},
        {id:"d8",tipo:"AEAT",archivo:"Requerimiento_2025.pdf",desc:"Requerimiento AEAT",periodo:"2025",doc:"docs/fiscal/Requerimiento_2025.pdf"},
        {id:"d9",tipo:"AEAT",archivo:"Recibo contestaci√≥n",desc:"Contestaci√≥n requerimiento",periodo:"2025",doc:"docs/fiscal/Eecibo_contestacio_n_requerimiento.pdf"},
        {id:"d10",tipo:"AEAT",archivo:"174545437Z26.pdf",desc:"Documento fiscal AEAT",periodo:"2025",doc:"docs/fiscal/174545437Z26.pdf"},
        {id:"d11",tipo:"AEAT",archivo:"174545437Z.pdf",desc:"Documento fiscal AEAT",periodo:"2025",doc:"docs/fiscal/174545437Z.pdf"},
        {id:"d12",tipo:"CCAA",archivo:"CERT_CCAA_2022.pdf",desc:"Aprobaci√≥n CCAA 2022",periodo:"2022",doc:"docs/corporativo/CERT_DE_APROB_CCAA_2022.pdf"},
        {id:"d13",tipo:"CCAA",archivo:"CERT_CCAA_2021.pdf",desc:"Aprobaci√≥n CCAA 2021",periodo:"2021",doc:"docs/corporativo/AZNAR_LEGALCERTIFICADO_DE_APROBACION_CCAA2021.pdf"},
        {id:"d14",tipo:"CCAA",archivo:"CERT_CCAA_2020.pdf",desc:"Certificaci√≥n 2020",periodo:"2020",doc:"docs/corporativo/CERTIFICACION_AZNAR_SLP_2020_copy.pdf"},
        {id:"d15",tipo:"CCAA",archivo:"CERT_CCAA_2019.pdf",desc:"Certificaci√≥n 2019",periodo:"2019",doc:"docs/corporativo/CERTIF__CCAA__2019__AZANAR_LEGAL_copy.pdf"},
        {id:"d16",tipo:"Balance",archivo:"BCE_2022.pdf",desc:"Balance 2022",periodo:"2022",doc:"docs/corporativo/BCE_2022.pdf"},
        {id:"d17",tipo:"Balance",archivo:"BCE_202214.pdf",desc:"Balance detallado 2022",periodo:"2022",doc:"docs/corporativo/BCE_202214.pdf"},
        {id:"d18",tipo:"PyG",archivo:"PG_2022.pdf",desc:"PyG 2022",periodo:"2022",doc:"docs/corporativo/PG_2022.pdf"},
        {id:"d19",tipo:"Contable",archivo:"BSPyG.xlsx",desc:"Balance y PyG (Excel)",periodo:"Hist√≥rico",doc:"docs/corporativo/BSPyG.xlsx"},
        {id:"d20",tipo:"Diario",archivo:"DIARIO_2023.xlsx",desc:"Diario contable 2023",periodo:"2023",doc:"docs/corporativo/DIARIO_2023.xlsx"},
        {id:"d21",tipo:"Certificado",archivo:"CertFirmaEPDF.pdf",desc:"Certificado firma electr√≥nica",periodo:"",doc:"docs/corporativo/CertFirmaEPDF.pdf"},
        {id:"d22",tipo:"Constituci√≥n",archivo:"2021BTC0523.pdf",desc:"Escritura constituci√≥n SLP",periodo:"2021",doc:"docs/corporativo/2021BTC0523.pdf"},
        {id:"d23",tipo:"Banco",archivo:"Movimientos.xlsx",desc:"Movimientos Bankinter",periodo:"2024-25",doc:"docs/banco/Movimientos_cuenta_corriente_ES1001287610380100000566.xlsx"},
        {id:"d24",tipo:"Banco",archivo:"Enero 2024.pdf",desc:"Extracto enero",periodo:"Ene 2024",doc:"docs/banco/january_2024.pdf"},
        {id:"d25",tipo:"Banco",archivo:"Febrero 2024.pdf",desc:"Extracto febrero",periodo:"Feb 2024",doc:"docs/banco/february_2024.pdf"},
        {id:"d26",tipo:"Banco",archivo:"Marzo 2024.pdf",desc:"Extracto marzo",periodo:"Mar 2024",doc:"docs/banco/march_2024.pdf"},
        {id:"d27",tipo:"Banco",archivo:"Bankinter Q1.htm",desc:"Movimientos Q1 2024",periodo:"Q1 2024",doc:"docs/banco/movimientos_bankinter_Q1_24.htm"},
        {id:"d28",tipo:"Vinculada",archivo:"Enrique Aznar 2024",desc:"Factura asesor√≠a vinculada",periodo:"2024",doc:"docs/recibidas/2024/EnriqueAznar_2024.pdf"},
        {id:"d29",tipo:"Vinculada",archivo:"Enrique Aznar 2025",desc:"Factura asesor√≠a vinculada",periodo:"2025",doc:"docs/recibidas/2025/EnriqueAznar_2025.pdf"},
        {id:"d30",tipo:"Vinculada",archivo:"Enrique Aznar rect.",desc:"Factura rectificativa",periodo:"2024",doc:"docs/recibidas/2024/EnriqueAznar_rect_2024.pdf"},
      ]}/>
    </div>;
    return null;
  };

  return (
    <div style={{display:"flex",height:"100vh",fontFamily:"system-ui,-apple-system,sans-serif",background:"#F4F6F9",color:"#2C3E50",overflow:"hidden"}}>
      {/* MODALS */}
      {modalEmitida && <ModalEmitida item={modalEmitida.id?modalEmitida:null} onSave={saveEmitida} onClose={()=>setModalEmitida(null)}/>}
      {modalRecibida && <ModalRecibida item={modalRecibida.id?modalRecibida:null} onSave={saveRecibida} onClose={()=>setModalRecibida(null)}/>}
      {confirmDelete && <ConfirmDialog msg={`¬øEliminar esta factura${confirmDelete.type==="emitida"?" emitida":" recibida"}?`} onYes={()=>confirmDelete.type==="emitida"?deleteEmitida(confirmDelete.item):deleteRecibida(confirmDelete.item)} onNo={()=>setConfirmDelete(null)}/>}
      {/* SIDEBAR */}
      {sideOpen&&<div style={{width:240,minWidth:240,background:"#fff",borderRight:"1px solid #E4E9F0",display:"flex",flexDirection:"column"}} className="no-print">
        <div style={{padding:"16px 20px",borderBottom:"1px solid #E4E9F0"}}>
          <img src={LOGO_SRC} alt="Aznar Legal & Compliance" style={{width:"100%",maxWidth:200,height:"auto"}}/>
          <div style={{marginTop:6,fontSize:11,color:"#7A8DA0",fontFamily:"monospace",letterSpacing:0.5}}>NIF: B67038695</div>
        </div>
        <div style={{padding:"10px 6px",flex:1,display:"flex",flexDirection:"column",gap:1}}>
          <NavItem icon="‚óà" label="Dashboard" active={section==="dashboard"} onClick={()=>{setSection("dashboard");setSearch("");}}/>
          <NavItem icon="‚Üó" label="Facturas Emitidas" active={section==="emitidas"} onClick={()=>{setSection("emitidas");setSearch("");}} badge={emitidas.length}/>
          <NavItem icon="‚Üô" label="Facturas Recibidas" active={section==="recibidas"} onClick={()=>{setSection("recibidas");setSearch("");}} badge={recibidas.length}/>
          <div style={{height:1,background:"#E4E9F0",margin:"6px 16px"}}/>
          <NavItem icon="%" label="IVA / Mod. 303" active={section==="iva"} onClick={()=>setSection("iva")}/>
          <NavItem icon="¬ß" label="Impuesto Sociedades" active={section==="is"} onClick={()=>setSection("is")}/>
          <div style={{height:1,background:"#E4E9F0",margin:"6px 16px"}}/>
          <NavItem icon="‚ö†" label="Alertas" active={section==="alertas"} onClick={()=>setSection("alertas")} badge={ALERTAS.length}/>
          <NavItem icon="üóÇ" label="Docs Fiscales" active={section==="docs"} onClick={()=>setSection("docs")}/>
        </div>
        <div style={{padding:"12px 20px",borderTop:"1px solid #E4E9F0",fontSize:10,color:"#A0AEBB"}}>Plataforma Contable v2.0 ¬∑ Claude AI</div>
      </div>}
      {/* MAIN */}
      <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 24px",borderBottom:"1px solid #E4E9F0",background:"#fff"}} className="no-print">
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <button onClick={()=>setSideOpen(!sideOpen)} style={{background:"none",border:"1px solid #D5DCE4",color:"#7A8DA0",cursor:"pointer",width:32,height:32,borderRadius:6,display:"flex",alignItems:"center",justifyContent:"center",fontSize:15}}>‚ò∞</button>
            <span style={{color:"#2E6B3A",fontSize:16,fontWeight:700}}>{sections[section]}</span>
          </div>
          <div style={{display:"flex",gap:4}}>
            {[2023,2024,2025].map(y=><button key={y} onClick={()=>{setYear(y);setSearch("");}} style={{padding:"6px 16px",borderRadius:6,border:year===y?"2px solid #3D7A4A":"1px solid #D5DCE4",background:year===y?"#3D7A4A":"#fff",color:year===y?"#fff":"#7A8DA0",cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"monospace"}}>{y}</button>)}
          </div>
        </div>
        <div style={{flex:1,overflow:"auto",padding:24}}>{renderSection()}</div>
      </div>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
