<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Aznar Legal & Compliance ‚Äî Plataforma Contable</title>
  <style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #F4F6F9; }
  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
  .modal { background: #fff; border-radius: 12px; padding: 28px; width: 90%; max-width: 620px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
  .modal h3 { color: #2E6B3A; margin-bottom: 18px; font-size: 18px; }
  .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
  .form-group { display: flex; flex-direction: column; flex: 1; }
  .form-group label { font-size: 11px; color: #7A8DA0; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; font-weight: 600; }
  .form-group input, .form-group select, .form-group textarea { padding: 8px 10px; border: 1px solid #D5DCE4; border-radius: 6px; font-size: 13px; font-family: system-ui; outline: none; transition: border 0.15s; }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #3D7A4A; }
  .btn { padding: 8px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.15s; }
  .btn-primary { background: #3D7A4A; color: #fff; }
  .btn-primary:hover { background: #2E6B3A; }
  .btn-danger { background: #C0392B; color: #fff; }
  .btn-danger:hover { background: #A93226; }
  .btn-secondary { background: #E4E9F0; color: #2C3E50; }
  .btn-secondary:hover { background: #D5DCE4; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  .btn-export { background: #2980B9; color: #fff; }
  .btn-export:hover { background: #2471A3; }
  .action-bar { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
  .search-input { padding: 8px 12px; border: 1px solid #D5DCE4; border-radius: 6px; font-size: 13px; width: 220px; outline: none; }
  .search-input:focus { border-color: #3D7A4A; }
  @media print { .no-print { display: none !important; } }
</style>
</head>
<body>
<div id="root"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  DATOS ‚Äî Cada archivo es independiente.                        -->
<!--  Editar un archivo de datos NO afecta a la interfaz.           -->
<!--  Editar la interfaz (abajo) NO afecta a los datos.             -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script src="data/config.js"></script>
<script src="data/modelos303.js"></script>
<script src="data/modelos390.js"></script>
<script src="data/emitidas.js"></script>
<script src="data/recibidas.js"></script>
<script src="data/alertas.js"></script>
<script src="data/modelo200.js"></script>
<script src="data/evolution.js"></script>
<script src="data/ccaa.js"></script>

<!-- React + Babel -->
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  INTERFAZ ‚Äî Motor contable + componentes React                 -->
<!--  Los datos est√°n arriba en data/*.js ‚Äî seguros e inmutables    -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="text/babel">
const { useState, useEffect, useCallback } = React;


// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
const fmt = n => n.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨";
const fmtDate = d => { if(!d) return ""; const p=d.split("-"); return p[2]+"/"+p[1]+"/"+p[0]; };


const toISO = d => { if(!d||d.includes("-")) return d; const p=d.split("/"); return p[2]+"-"+p[1]+"-"+p[0]; };
const sum = (arr,key) => arr.reduce((s,r)=>s+(r[key]||0),0);
const getQ = fecha => { const m=parseInt(fecha.split("-")[1]); if(m<=3) return "Q1"; if(m<=6) return "Q2"; if(m<=9) return "Q3"; return "Q4"; };
const genId = () => "id-"+Date.now()+"-"+Math.random().toString(36).substr(2,5);
const calcIva = (base,tipo) => Math.round(base*tipo/100*100)/100;
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê  MOTOR CONTABLE PGC  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PGC = {
  "100":"Capital social","112":"Reserva legal","129":"Resultado del ejercicio",
  "206":"Aplicaciones inform√°ticas","217":"Equipos proc. informaci√≥n",
  "280":"AA inmov. intangible","281":"AA inmov. material",
  "430":"Clientes","410":"Acreedores prest. servicios",
  "472":"HP IVA soportado","477":"HP IVA repercutido",
  "4700":"HP deudora IVA","4750":"HP acreedora IVA","4752":"HP acreedora IS",
  "572":"Bancos c/c",
  "623":"Servicios prof. independientes","625":"Primas de seguros",
  "627":"Publicidad y RRPP","628":"Suministros",
  "629":"Otros servicios","631":"Otros tributos",
  "680":"Amort. inmov. intangible","681":"Amort. inmov. material",
  "705":"Prestaciones de servicios",
};
const ctaName = c => PGC[c] ? `${c} ${PGC[c]}` : c;
const CAT_CUENTA = {
  "Telecom":"628","Software":"629","Software int.":"629","Suscripciones":"629",
  "Libros":"629","Transporte":"624","Restauraci√≥n":"627","Vinculada":"623","Otros":"629",
  "Servicios prof.":"623","Banco":"626","Profesional int.":"629","Viajes":"624","Viajes int.":"629",
  "Marketing":"629","Hosting":"629",
};
// Equipos: >300‚Ç¨ base ‚Üí 217 (activo amortizable), ‚â§300‚Ç¨ ‚Üí 629 (gasto directo)
const AMORT_RATE = 0.25; // 25% anual equipos inform√°ticos
function generarAsientos(emitidas, recibidas, year, allRecibidas) {
  const preAsientos = [];
  // ‚îÄ‚îÄ‚îÄ Facturas emitidas ‚îÄ‚îÄ‚îÄ
  [...emitidas].forEach(e => {
    const apuntes = [];
    apuntes.push({cuenta:"430",nombre:ctaName("430"),debe:e.total,haber:0});
    apuntes.push({cuenta:"705",nombre:ctaName("705"),debe:0,haber:e.base});
    if(e.iva>0) apuntes.push({cuenta:"477",nombre:ctaName("477"),debe:0,haber:e.iva});
    preAsientos.push({fecha:e.fecha,tipo:"FE",concepto:`Fra.${e.num} ‚Äî ${e.cliente}`,ref:e.id,apuntes});
  });
  // ‚îÄ‚îÄ‚îÄ Facturas recibidas ‚îÄ‚îÄ‚îÄ
  [...recibidas].forEach(r => {
    const apuntes = [];
    const esActivo = r.cat==="Equipos" && r.base>300;
    const ctaGasto = esActivo ? "217" : (CAT_CUENTA[r.cat]||"629");
    apuntes.push({cuenta:ctaGasto,nombre:ctaName(ctaGasto),debe:r.base,haber:0});
    if(r.iva>0) apuntes.push({cuenta:"472",nombre:ctaName("472"),debe:r.iva,haber:0});
    apuntes.push({cuenta:"410",nombre:ctaName("410"),debe:0,haber:r.total});
    preAsientos.push({fecha:r.fecha,tipo:"FR",concepto:`${r.prov||r.proveedor} ‚Äî ${r.desc}`,ref:r.id,apuntes,esActivo});
  });
  // ‚îÄ‚îÄ‚îÄ Amortizaciones (incluye activos de a√±os anteriores que siguen vivos) ‚îÄ‚îÄ‚îÄ
  const todosActivos = allRecibidas.filter(r=>r.cat==="Equipos"&&r.base>300);
  if(todosActivos.length>0) {
    const trimestres = ["Q1","Q2","Q3","Q4"];
    const fechasTrim = [`${year}-03-31`,`${year}-06-30`,`${year}-09-30`,`${year}-12-31`];
    trimestres.forEach((q,qi) => {
      let cuotaTrim = 0;
      todosActivos.forEach(a => {
        const yAdq = parseInt(a.fecha.split("-")[0]);
        const mAdq = parseInt(a.fecha.split("-")[1]);
        // Solo si a√∫n no est√° totalmente amortizado (4 a√±os al 25%)
        if(year - yAdq > 4) return;
        if(yAdq > year) return;
        if(yAdq === year && mAdq > (qi+1)*3) return;
        const inicioTrim = qi*3+1;
        const finTrim = (qi+1)*3;
        let meses = 0;
        for(let m=inicioTrim;m<=finTrim;m++) {
          if(yAdq < year || (yAdq===year && mAdq<=m)) meses++;
        }
        cuotaTrim += (a.base * AMORT_RATE / 12) * meses;
      });
      if(cuotaTrim > 0) {
        cuotaTrim = Math.round(cuotaTrim*100)/100;
        preAsientos.push({fecha:fechasTrim[qi],tipo:"AM",concepto:`Amortizaci√≥n EPI ${q} ${year}`,apuntes:[
          {cuenta:"681",nombre:ctaName("681"),debe:cuotaTrim,haber:0},
          {cuenta:"281",nombre:ctaName("281"),debe:0,haber:cuotaTrim},
        ]});
      }
    });
  }
  // ‚îÄ‚îÄ‚îÄ Sort ALL entries chronologically, then number ‚îÄ‚îÄ‚îÄ
  preAsientos.sort((a,b)=>a.fecha.localeCompare(b.fecha));
  const asientos = [];
  let n = 1;
  preAsientos.forEach(a => { asientos.push({...a, n:n++}); });
  return asientos;
}
function generarMayor(asientos) {
  const cuentas = {};
  asientos.forEach(a => {
    a.apuntes.forEach(ap => {
      if(!cuentas[ap.cuenta]) cuentas[ap.cuenta] = {cuenta:ap.cuenta,nombre:ap.nombre,debe:0,haber:0,movs:[]};
      cuentas[ap.cuenta].debe += ap.debe;
      cuentas[ap.cuenta].haber += ap.haber;
      cuentas[ap.cuenta].movs.push({fecha:a.fecha,concepto:a.concepto,debe:ap.debe,haber:ap.haber});
    });
  });
  return Object.values(cuentas).sort((a,b)=>a.cuenta.localeCompare(b.cuenta)).map(c=>({...c,saldo:c.debe-c.haber}));
}
function generarBalance(mayor) {
  // Activo: cuentas grupo 2 (inmov.), 4 deudoras (430,472,4700), 5 (tesorer√≠a) con saldo deudor
  // Pasivo: cuentas grupo 1 (fondos propios), 4 acreedoras (410,477,4750,4752) con saldo acreedor
  const activo = mayor.filter(m => {
    const g = m.cuenta.charAt(0);
    if(g==="2") return true; // Inmovilizado (incluye 281 con saldo negativo = amort acum)
    if(m.cuenta==="430"||m.cuenta==="472"||m.cuenta==="4700") return m.saldo>0;
    if(g==="5") return m.saldo>0;
    return false;
  });
  const pasivo = mayor.filter(m => {
    const g = m.cuenta.charAt(0);
    if(g==="1") return true;
    if(m.cuenta==="410"||m.cuenta==="477"||m.cuenta==="4750"||m.cuenta==="4752") return m.saldo<0;
    return false;
  });
  return {activo,pasivo,tActivo:activo.reduce((s,m)=>s+m.saldo,0),tPasivo:pasivo.reduce((s,m)=>s+Math.abs(m.saldo),0)};
}
function generarPyG(mayor) {
  const ingresos = mayor.filter(m=>m.cuenta.startsWith("7"));
  const gastos = mayor.filter(m=>m.cuenta.startsWith("6"));
  const tIngresos = ingresos.reduce((s,m)=>s+m.haber-m.debe,0);
  const tGastos = gastos.reduce((s,m)=>s+m.debe-m.haber,0);
  return {ingresos,gastos,tIngresos,tGastos,resultado:tIngresos-tGastos};
}
function loadData(key, def) { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : def; } catch(e) { return def; } }
function saveData(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {} }
 // v9.3: CCAA 2023+2024 reemplazados con datos oficiales Modelo 200

function exportCSV(data, filename, cols) {
  const header = cols.map(c=>c.label).join(";");
  const rows = data.map(r => cols.map(c => { let v = c.key ? r[c.key] : (c.get ? c.get(r) : ""); if(typeof v==="number") v=v.toString().replace(".",","); return '"'+String(v).replace(/"/g,'""')+'"'; }).join(";"));
  const csv = "\uFEFF"+header+"\n"+rows.join("\n");
  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}
// ‚îÄ‚îÄ‚îÄ SHARED COMPONENTS ‚îÄ‚îÄ‚îÄ
const Badge = ({type,children}) => {
  const c = {warning:{bg:"#FEF9E7",text:"#7D6608",b:"#F9E79F"},error:{bg:"#FDEDEC",text:"#922B21",b:"#F5B7B1"},info:{bg:"#EAF2F8",text:"#1A5276",b:"#AED6F1"},success:{bg:"#EAFAF1",text:"#1E8449",b:"#A9DFBF"}}[type]||{bg:"#EAF2F8",text:"#1A5276",b:"#AED6F1"};
  return <span style={{background:c.bg,color:c.text,padding:"2px 8px",borderRadius:4,fontSize:10,fontWeight:600,border:`1px solid ${c.b}`}}>{children}</span>;
};
const KPI = ({label,value,sub,color,onClick}) => (
  <div onClick={onClick} style={{background:"#fff",borderRadius:10,padding:"16px 20px",flex:1,minWidth:160,border:"1px solid #E4E9F0",boxShadow:"0 1px 3px rgba(0,0,0,0.04)",cursor:onClick?"pointer":"default"}}>
    <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:6,fontWeight:700}}>{label}</div>
    <div style={{color:color||"#2E6B3A",fontSize:20,fontWeight:700,fontFamily:"monospace"}}>{value}</div>
    {sub&&<div style={{color:"#A0AEBB",fontSize:11,marginTop:3}}>{sub}</div>}
  </div>
);
const NavItem = ({icon,label,active,onClick,badge}) => (
  <button onClick={onClick} style={{display:"flex",alignItems:"center",gap:10,padding:"10px 20px",width:"100%",background:active?"#EBF2EB":"transparent",border:"none",cursor:"pointer",color:active?"#2E6B3A":"#7A8DA0",fontSize:13,fontFamily:"system-ui",borderLeft:active?"3px solid #3D7A4A":"3px solid transparent",borderRadius:"0 6px 6px 0",textAlign:"left",fontWeight:active?600:400,transition:"all 0.15s"}}>
    <span style={{fontSize:15,width:20,textAlign:"center"}}>{icon}</span>
    <span style={{flex:1}}>{label}</span>
    {badge!=null&&<span style={{background:"#3D7A4A",color:"#fff",borderRadius:10,padding:"1px 7px",fontSize:10,fontWeight:700}}>{badge}</span>}
  </button>
);
// ‚îÄ‚îÄ‚îÄ MODAL FORM: EMITIDA ‚îÄ‚îÄ‚îÄ
function ModalEmitida({item, onSave, onClose}) {
  const [f, setF] = useState(item || {num:"",fecha:"",cliente:"",nif:"",desc:"",base:0,tipoIva:21});
  const upd = (k,v) => setF({...f,[k]:v});
  const save = () => {
    const base = parseFloat(f.base)||0;
    const tipoIva = parseFloat(f.tipoIva)||0;
    const iva = calcIva(base,tipoIva);
    const total = base+iva;
    const trimestre = getQ(f.fecha);
    onSave({...f, id:f.id||genId(), base, tipoIva, iva, total, trimestre});
  };
  return <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>{item?"Editar":"Nueva"} Factura Emitida</h3>
    <div className="form-row">
      <div className="form-group"><label>N¬∫ Factura</label><input value={f.num} onChange={e=>upd("num",e.target.value)} placeholder="1/2025"/></div>
      <div className="form-group"><label>Fecha</label><input type="date" value={f.fecha} onChange={e=>upd("fecha",e.target.value)}/></div>
    </div>
    <div className="form-row">
      <div className="form-group"><label>Cliente</label><input value={f.cliente} onChange={e=>upd("cliente",e.target.value)}/></div>
      <div className="form-group"><label>NIF</label><input value={f.nif} onChange={e=>upd("nif",e.target.value)}/></div>
    </div>
    <div className="form-row">
      <div className="form-group" style={{flex:3}}><label>Descripci√≥n</label><input value={f.desc} onChange={e=>upd("desc",e.target.value)}/></div>
    </div>
    <div className="form-row">
      <div className="form-group" style={{flex:3}}><label>Ruta documento (relativa, ej: docs/emitidas/2025/mi_factura.pdf)</label><input value={f.doc||""} onChange={e=>upd("doc",e.target.value)} placeholder="docs/emitidas/2025/..."/></div>
    </div>
    <div className="form-row">
      <div className="form-group"><label>Base imponible (‚Ç¨)</label><input type="number" step="0.01" value={f.base} onChange={e=>upd("base",e.target.value)}/></div>
      <div className="form-group"><label>Tipo IVA (%)</label><select value={f.tipoIva} onChange={e=>upd("tipoIva",parseFloat(e.target.value))}><option value={21}>21%</option><option value={10}>10%</option><option value={4}>4%</option><option value={0}>0% (exento)</option></select></div>
      <div className="form-group"><label>IVA</label><div style={{padding:"8px 0",fontFamily:"monospace",fontSize:13}}>{fmt(calcIva(parseFloat(f.base)||0,parseFloat(f.tipoIva)||0))}</div></div>
      <div className="form-group"><label>Total</label><div style={{padding:"8px 0",fontFamily:"monospace",fontSize:13,fontWeight:700,color:"#2E6B3A"}}>{fmt((parseFloat(f.base)||0)+calcIva(parseFloat(f.base)||0,parseFloat(f.tipoIva)||0))}</div></div>
    </div>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16}}>
      <button className="btn btn-secondary" onClick={onClose}>Cancelar</button>
      <button className="btn btn-primary" onClick={save}>Guardar</button>
    </div>
  </div></div>;
}
// ‚îÄ‚îÄ‚îÄ MODAL FORM: RECIBIDA ‚îÄ‚îÄ‚îÄ
function ModalRecibida({item, onSave, onClose}) {
  const cats = ["Telecom","Equipos","Software","Software int.","Suscripciones","Libros","Transporte","Restauraci√≥n","Vinculada","Otros"];
  const [f, setF] = useState(item || {fecha:"",prov:"",desc:"",base:0,tipoIva:21,cat:"Otros"});
  const upd = (k,v) => setF({...f,[k]:v});
  const save = () => {
    const base = parseFloat(f.base)||0;
    const tipoIva = parseFloat(f.tipoIva)||0;
    const iva = calcIva(base,tipoIva);
    const total = base+iva;
    const trimestre = getQ(f.fecha);
    onSave({...f, id:f.id||genId(), base, tipoIva, iva, total, trimestre});
  };
  return <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3>{item?"Editar":"Nueva"} Factura Recibida</h3>
    <div className="form-row">
      <div className="form-group"><label>Fecha</label><input type="date" value={f.fecha} onChange={e=>upd("fecha",e.target.value)}/></div>
      <div className="form-group"><label>Proveedor</label><input value={f.prov||f.proveedor} onChange={e=>upd("prov",e.target.value)}/></div>
      <div className="form-group"><label>Categor√≠a</label><select value={f.cat} onChange={e=>upd("cat",e.target.value)}>{cats.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
    </div>
    <div className="form-row">
      <div className="form-group" style={{flex:3}}><label>Descripci√≥n</label><input value={f.desc} onChange={e=>upd("desc",e.target.value)}/></div>
    </div>
    <div className="form-row">
      <div className="form-group" style={{flex:3}}><label>Ruta documento (relativa, ej: docs/recibidas/2025/factura.pdf)</label><input value={f.doc||""} onChange={e=>upd("doc",e.target.value)} placeholder="docs/recibidas/2025/..."/></div>
    </div>
    <div className="form-row">
      <div className="form-group"><label>Base imponible (‚Ç¨)</label><input type="number" step="0.01" value={f.base} onChange={e=>upd("base",e.target.value)}/></div>
      <div className="form-group"><label>Tipo IVA (%)</label><select value={f.tipoIva} onChange={e=>upd("tipoIva",parseFloat(e.target.value))}><option value={21}>21%</option><option value={10}>10%</option><option value={4}>4%</option><option value={0}>0% (exento/no sujeto)</option></select></div>
      <div className="form-group"><label>IVA</label><div style={{padding:"8px 0",fontFamily:"monospace",fontSize:13}}>{fmt(calcIva(parseFloat(f.base)||0,parseFloat(f.tipoIva)||0))}</div></div>
      <div className="form-group"><label>Total</label><div style={{padding:"8px 0",fontFamily:"monospace",fontSize:13,fontWeight:700,color:"#C0392B"}}>{fmt((parseFloat(f.base)||0)+calcIva(parseFloat(f.base)||0,parseFloat(f.tipoIva)||0))}</div></div>
    </div>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:16}}>
      <button className="btn btn-secondary" onClick={onClose}>Cancelar</button>
      <button className="btn btn-primary" onClick={save}>Guardar</button>
    </div>
  </div></div>;
}
// ‚îÄ‚îÄ‚îÄ CONFIRM DIALOG ‚îÄ‚îÄ‚îÄ
function ConfirmDialog({msg, onYes, onNo}) {
  return <div className="modal-overlay" onClick={onNo}><div className="modal" onClick={e=>e.stopPropagation()} style={{maxWidth:400}}>
    <h3 style={{color:"#C0392B"}}>Confirmar</h3>
    <p style={{margin:"12px 0 20px",fontSize:14,color:"#2C3E50"}}>{msg}</p>
    <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
      <button className="btn btn-secondary" onClick={onNo}>Cancelar</button>
      <button className="btn btn-danger" onClick={onYes}>Eliminar</button>
    </div>
  </div></div>;
}
// ‚îÄ‚îÄ‚îÄ DATA TABLE ‚îÄ‚îÄ‚îÄ
const DataTable = ({columns,data,maxH,onEdit,onDelete}) => (
  <div style={{overflowX:"auto",overflowY:maxH?"auto":"visible",maxHeight:maxH,borderRadius:8,border:"1px solid #E4E9F0",background:"#fff"}}>
    <table style={{width:"100%",borderCollapse:"collapse",fontSize:12,fontFamily:"system-ui"}}>
      <thead><tr>
        {columns.map((c,i)=><th key={i} style={{padding:"10px 12px",textAlign:c.align||"left",color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:0.8,borderBottom:"2px solid #3D7A4A",background:"#FAFBFC",position:"sticky",top:0,whiteSpace:"nowrap",fontWeight:700}}>{c.label}</th>)}
        {(onEdit||onDelete)&&<th style={{padding:"10px 12px",textAlign:"center",color:"#7A8DA0",fontSize:10,textTransform:"uppercase",borderBottom:"2px solid #3D7A4A",background:"#FAFBFC",position:"sticky",top:0,fontWeight:700,width:90}}>Acciones</th>}
      </tr></thead>
      <tbody>{data.map((row,ri)=><tr key={row.id||ri} onMouseEnter={e=>e.currentTarget.style.background="#F7F9F7"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
        {columns.map((c,ci)=><td key={ci} style={{padding:"8px 12px",color:c.color||"#2C3E50",borderBottom:"1px solid #F0F2F5",textAlign:c.align||"left",whiteSpace:c.nowrap?"nowrap":"normal",fontFamily:c.mono?"monospace":"system-ui",fontWeight:c.bold?600:400,fontSize:c.mono?11:12}}>{c.render?c.render(row):row[c.key]}</td>)}
        {(onEdit||onDelete)&&<td style={{padding:"8px 6px",borderBottom:"1px solid #F0F2F5",textAlign:"center",whiteSpace:"nowrap"}}>
          {onEdit&&<button className="btn btn-sm btn-secondary" style={{marginRight:4}} onClick={()=>onEdit(row)}>‚úèÔ∏è</button>}
          {onDelete&&<button className="btn btn-sm btn-danger" onClick={()=>onDelete(row)}>üóë</button>}
        </td>}
      </tr>)}</tbody>
    </table>
  </div>
);
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê  MAIN APP  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ CCAA Official Rendering Components ‚îÄ‚îÄ‚îÄ
const OfficialBalanceView = ({year, fmt}) => {
  const oc = OFFICIAL_CCAA[year].balance;
  const BsLine = ({item}) => {
    const indent = (item.level||0)*16+10;
    const isAcct = item.level>=2 && /^\d/.test(item.label);
    return <div style={{display:"flex",justifyContent:"space-between",padding:item.bold?"7px 0":"4px 0",paddingLeft:indent,fontSize:item.bold?12:isAcct?10:11,borderBottom:"1px solid #F0F2F5",background:item.bold?"#FAFBFC":"transparent"}}>
      <span style={{color:item.bold?"#2C3E50":isAcct?"#999":"#7A8DA0",fontWeight:item.bold?700:item.highlight?600:400,fontStyle:item.highlight?"italic":"normal"}}>{item.label}</span>
      <span style={{fontFamily:"monospace",fontSize:item.bold?12:11,fontWeight:item.bold?700:400,color:item.val<0?"#C0392B":item.highlight?(item.val>=0?"#27AE60":"#C0392B"):"#2C3E50",paddingRight:10}}>{fmt(item.val)}</span>
    </div>;
  };
  return <div>
    <div style={{fontSize:10,color:"#999",marginBottom:10,fontStyle:"italic"}}>{OFFICIAL_CCAA[year].sustitutiva&&<span style={{background:"#E74C3C",color:"#fff",padding:"2px 6px",borderRadius:3,fontSize:9,fontWeight:700,marginRight:6}}>SUSTITUTIVA</span>}üìã Fuente: {OFFICIAL_CCAA[year].fuente}</div>
    <div style={{display:"flex",gap:16,flexWrap:"wrap"}}>
      <div style={{flex:1,minWidth:320,background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden"}}>
        <div style={{padding:"10px 16px",fontSize:13,fontWeight:700,color:"#2E6B3A",borderBottom:"2px solid #2E6B3A",background:"#FAFBFC"}}>ACTIVO</div>
        {oc.activo.map((item,i)=><BsLine key={i} item={item}/>)}
        <div style={{display:"flex",justifyContent:"space-between",padding:"12px 16px",fontSize:14,fontWeight:700,borderTop:"3px solid #2E6B3A",background:"#EAFAF1"}}>
          <span>TOTAL ACTIVO</span><span style={{fontFamily:"monospace",color:"#2E6B3A"}}>{fmt(oc.totalActivo)}</span>
        </div>
      </div>
      <div style={{flex:1,minWidth:320,background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden"}}>
        <div style={{padding:"10px 16px",fontSize:13,fontWeight:700,color:"#2980B9",borderBottom:"2px solid #2980B9",background:"#FAFBFC"}}>PATRIMONIO NETO Y PASIVO</div>
        {oc.pasivo.map((item,i)=><BsLine key={i} item={item}/>)}
        <div style={{display:"flex",justifyContent:"space-between",padding:"12px 16px",fontSize:14,fontWeight:700,borderTop:"3px solid #2980B9",background:"#EBF5FB"}}>
          <span>TOTAL PN + PASIVO</span><span style={{fontFamily:"monospace",color:"#2980B9"}}>{fmt(oc.totalPasivo)}</span>
        </div>
        {oc.descuadre&&<div style={{padding:"6px 16px",fontSize:10,color:"#E67E22",background:"#FEF9E7"}}>‚ö†Ô∏è Descuadre de ~{oc.descuadre}‚Ç¨ en el Modelo 200 presentado (activo {fmt(oc.totalActivo)} vs PN+P {fmt(oc.totalPasivo)})</div>}
      </div>
    </div>
    {oc.totalActivo===oc.totalPasivo&&<div style={{textAlign:"center",marginTop:8,fontSize:11,color:"#27AE60",fontWeight:600}}>‚úÖ Balance cuadrado: Activo = PN + Pasivo = {fmt(oc.totalActivo)}</div>}
  </div>;
};
const OfficialPyGView = ({year, fmt}) => {
  const lines = OFFICIAL_CCAA[year].pyg;
  return <div>
    <div style={{fontSize:10,color:"#999",marginBottom:10,fontStyle:"italic"}}>{OFFICIAL_CCAA[year].sustitutiva&&<span style={{background:"#E74C3C",color:"#fff",padding:"2px 6px",borderRadius:3,fontSize:9,fontWeight:700,marginRight:6}}>SUSTITUTIVA</span>}üìã Fuente: {OFFICIAL_CCAA[year].fuente}</div>
    <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden"}}>
      {lines.map((l,i)=>{
        const isTotal = l.total||l.final;
        const isAcct = l.level>=1 && /^\d/.test(l.label);
        const indent = 20+(l.level||0)*16;
        return <div key={i} style={{
          display:"flex",justifyContent:"space-between",
          padding:isTotal?"12px 20px":("6px 20px 6px "+indent+"px"),
          fontSize:l.final?15:isTotal?13:isAcct?10:12,
          fontWeight:(l.bold||isTotal)?700:400,
          background:l.final?"#F0FFF4":isTotal?"#FAFBFC":"transparent",
          borderBottom:l.final?"none":isTotal?"2px solid #E4E9F0":"1px solid #F0F2F5",
          borderTop:l.final?"3px solid #2E6B3A":isTotal?"1px solid #E4E9F0":"none",
        }}>
          <span style={{color:isAcct?"#999":l.level===1?"#7A8DA0":"#2C3E50"}}>{l.label}</span>
          <span style={{fontFamily:"monospace",fontWeight:isTotal?700:400,paddingRight:10,color:l.val>=0?(l.final?"#27AE60":"#2C3E50"):"#C0392B"}}>{fmt(l.val)}</span>
        </div>;
      })}
    </div>
  </div>;
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê  MOTOR DE RECONCILIACI√ìN IVA  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function vatEngine(emitidas, recibidas, year) {
  const quarters = ["Q1","Q2","Q3","Q4"];
  const aeat = MODELOS_303[year] || [];
  return quarters.map((q, qi) => {
    const eQ = emitidas.filter(e => e.trimestre === q);
    const rQ = recibidas.filter(r => r.trimestre === q);
    // ‚Äî Calculado desde facturas ‚Äî
    const calcBase21 = eQ.filter(e => e.tipoIva === 21).reduce((s, e) => s + e.base, 0);
    const calcCuotaDev = eQ.filter(e => e.tipoIva === 21).reduce((s, e) => s + e.iva, 0);
    const calcBaseExenta = eQ.filter(e => e.tipoIva === 0).reduce((s, e) => s + e.base, 0);
    const calcBaseSop = rQ.filter(r => r.tipoIva > 0).reduce((s, r) => s + r.base, 0);
    const calcCuotaDed = rQ.filter(r => r.tipoIva > 0).reduce((s, r) => s + r.iva, 0);
    const calcResultado = +(calcCuotaDev - calcCuotaDed).toFixed(2);
    // ‚Äî Dato oficial AEAT ‚Äî
    const m = aeat.find(a => a.periodo === q) || null;
    const aeatBase21 = m ? m.baseImponible21 : null;
    const aeatCuotaDev = m ? m.cuotaDevengada : null;
    const aeatBaseSop = m ? m.baseIvaSoportado : null;
    const aeatCuotaDed = m ? m.cuotaDeducible : null;
    const aeatResultado = m ? m.resultadoRegimen : null;
    // ‚Äî Deltas ‚Äî
    const delta = (calc, aeat) => aeat !== null ? +(calc - aeat).toFixed(2) : null;
    // ‚Äî Facturas sin IVA que podr√≠an tenerlo (sospechosas) ‚Äî
    const suspicious = rQ.filter(r => r.tipoIva === 0 && r.base > 0 && !["Banco","Vinculada"].includes(r.cat) && !r.prov?.includes("Bankinter") && !r.prov?.includes("Enrique Aznar"));
    return {
      q, qi, m,
      calc: { base21: calcBase21, cuotaDev: calcCuotaDev, baseExenta: calcBaseExenta, baseSop: calcBaseSop, cuotaDed: calcCuotaDed, resultado: calcResultado },
      aeat: { base21: aeatBase21, cuotaDev: aeatCuotaDev, baseSop: aeatBaseSop, cuotaDed: aeatCuotaDed, resultado: aeatResultado },
      delta: { base21: delta(calcBase21, aeatBase21), cuotaDev: delta(calcCuotaDev, aeatCuotaDev), baseSop: delta(calcBaseSop, aeatBaseSop), cuotaDed: delta(calcCuotaDed, aeatCuotaDed), resultado: delta(calcResultado, aeatResultado) },
      emitidas: eQ, recibidas: rQ, suspicious,
      hasAeat: m !== null
    };
  });
}
function App() {
  const [section, setSection] = useState("dashboard");
  const [year, setYear] = useState(2025);
  const [sideOpen, setSideOpen] = useState(true);
  const [search, setSearch] = useState("");
  const [libroView, setLibroView] = useState(null);
  const [expandedIVA, setExpandedIVA] = useState(null);
  // ‚îÄ‚îÄ‚îÄ PERSISTENT DATA (all years) ‚îÄ‚îÄ‚îÄ
  const YEARS = [2017,2018,2019,2020,2021,2022,2023,2024,2025,2026];
  const defaults = {emitidas_2022:DEFAULT_EMITIDAS_2022,emitidas_2023:DEFAULT_EMITIDAS_2023,emitidas_2024:DEFAULT_EMITIDAS_2024,emitidas_2025:DEFAULT_EMITIDAS_2025,recibidas_2022:DEFAULT_RECIBIDAS_2022,recibidas_2023:DEFAULT_RECIBIDAS_2023,recibidas_2024:DEFAULT_RECIBIDAS_2024,recibidas_2025:DEFAULT_RECIBIDAS_2025,emitidas_2026:DEFAULT_EMITIDAS_2026,recibidas_2026:DEFAULT_RECIBIDAS_2026};
  const [store, setStore] = useState(()=>{
    const s={};
    YEARS.forEach(y=>{
      s[`emitidas_${y}`]=loadData(`emitidas_${y}`,defaults[`emitidas_${y}`]||[]);
      s[`recibidas_${y}`]=loadData(`recibidas_${y}`,defaults[`recibidas_${y}`]||[]);
    });
    return s;
  });
  const updateStore = useCallback((key,val)=>{
    setStore(prev=>{const n={...prev,[key]:val};saveData(key,val);return n;});
  },[]);
  const emitidas = store[`emitidas_${year}`]||[];
  const setEmitidas = useCallback(fn=>{
    const key=`emitidas_${year}`;
    setStore(prev=>{const cur=prev[key]||[];const nv=typeof fn==="function"?fn(cur):fn;saveData(key,nv);return {...prev,[key]:nv};});
  },[year]);
  const recibidas = store[`recibidas_${year}`]||[];
  const setRecibidas = useCallback(fn=>{
    const key=`recibidas_${year}`;
    setStore(prev=>{const cur=prev[key]||[];const nv=typeof fn==="function"?fn(cur):fn;saveData(key,nv);return {...prev,[key]:nv};});
  },[year]);
  // ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ
  const [modalEmitida, setModalEmitida] = useState(null); // null=closed, {}=new, {data}=edit
  const [modalRecibida, setModalRecibida] = useState(null);
  const [confirmDelete, setConfirmDelete] = useState(null); // {type,item}
  // ‚îÄ‚îÄ‚îÄ CRUD EMITIDAS ‚îÄ‚îÄ‚îÄ
  const saveEmitida = (item) => {
    setEmitidas(prev => { const idx=prev.findIndex(x=>x.id===item.id); if(idx>=0){ const n=[...prev]; n[idx]=item; return n; } return [...prev,item]; });
    setModalEmitida(null);
  };
  const deleteEmitida = (item) => { setEmitidas(prev=>prev.filter(x=>x.id!==item.id)); setConfirmDelete(null); };
  // ‚îÄ‚îÄ‚îÄ CRUD RECIBIDAS ‚îÄ‚îÄ‚îÄ
  const saveRecibida = (item) => {
    setRecibidas(prev => { const idx=prev.findIndex(x=>x.id===item.id); if(idx>=0){ const n=[...prev]; n[idx]=item; return n; } return [...prev,item]; });
    setModalRecibida(null);
  };
  const deleteRecibida = (item) => { setRecibidas(prev=>prev.filter(x=>x.id!==item.id)); setConfirmDelete(null); };
  // ‚îÄ‚îÄ‚îÄ AGGREGATES ‚îÄ‚îÄ‚îÄ
  const tIB=sum(emitidas,"base"), tIR=sum(emitidas,"iva");
  const tGB=sum(recibidas,"base"), tGI=sum(recibidas,"iva");
  const resultado=tIB-tGB, ivaNet=tIR-tGI;
  const qd=["Q1","Q2","Q3","Q4"].map(q=>({q,iR:sum(emitidas.filter(e=>e.trimestre===q),"iva"),iS:sum(recibidas.filter(r=>r.trimestre===q),"iva"),bE:sum(emitidas.filter(e=>e.trimestre===q),"base"),bR:sum(recibidas.filter(r=>r.trimestre===q),"base")}));
  const catD={}; recibidas.forEach(r=>{catD[r.cat]=(catD[r.cat]||0)+r.base;}); const catS=Object.entries(catD).sort((a,b)=>b[1]-a[1]);
  const maxC=catS[0]?.[1]||1;
  const cc=["#3D7A4A","#2980B9","#27AE60","#E67E22","#8E44AD","#C0392B","#16A085","#D4AC0D"];
  const sections = {dashboard:"Panel de Control",emitidas:"Facturas Emitidas",recibidas:"Facturas Recibidas",iva:"IVA ‚Äî Modelo 303",is:"Impuesto sobre Sociedades",libros:"Libros y Actas",alertas:"Alertas y Gaps",reconciliacion:"Reconciliaci√≥n IVA"};
  // ‚îÄ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ‚îÄ
  const filteredEmitidas = emitidas.filter(e => !search || [e.num,e.cliente,e.desc,e.nif].some(s=>(s||"").toLowerCase().includes(search.toLowerCase())));
  const filteredRecibidas = recibidas.filter(r => !search || [r.prov||r.proveedor,r.desc,r.cat].some(s=>(s||"").toLowerCase().includes(search.toLowerCase())));
  // ‚îÄ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ
  const exportEmitidas = () => exportCSV(emitidas, `emitidas_${year}.csv`, [
    {label:"N¬∫",key:"num"},{label:"Fecha",key:"fecha",get:r=>fmtDate(r.fecha)},{label:"Cliente",key:"cliente"},{label:"NIF",key:"nif"},{label:"Descripci√≥n",key:"desc"},{label:"Base",key:"base"},{label:"Tipo IVA",key:"tipoIva"},{label:"IVA",key:"iva"},{label:"Total",key:"total"},{label:"Trimestre",key:"trimestre"}
  ]);
  const exportRecibidas = () => exportCSV(recibidas, `recibidas_${year}.csv`, [
    {label:"Fecha",key:"fecha",get:r=>fmtDate(r.fecha)},{label:"Proveedor",get:r=>r.prov||r.proveedor},{label:"Descripci√≥n",key:"desc"},{label:"Base",key:"base"},{label:"Tipo IVA",key:"tipoIva"},{label:"IVA",key:"iva"},{label:"Total",key:"total"},{label:"Categor√≠a",key:"cat"},{label:"Trimestre",key:"trimestre"}
  ]);
  // ‚îÄ‚îÄ‚îÄ RENDER SECTIONS ‚îÄ‚îÄ‚îÄ
  const renderSection = () => {
    if(section==="dashboard") return <div style={{display:"flex",flexDirection:"column",gap:18}}>
      <div style={{display:"flex",gap:14,flexWrap:"wrap"}}>
        <KPI label="Ingresos" value={fmt(tIB)} sub={`${emitidas.length} facturas`} onClick={()=>setSection("emitidas")}/>
        <KPI label="Gastos" value={fmt(tGB)} sub={`${recibidas.length} facturas`} color="#C0392B" onClick={()=>setSection("recibidas")}/>
        <KPI label="Resultado" value={fmt(resultado)} color={resultado>=0?"#27AE60":"#C0392B"} sub={resultado>=0?"Beneficio":"P√©rdida"} onClick={()=>setSection("is")}/>
        <KPI label="IVA neto" value={fmt(ivaNet)} color={ivaNet>=0?"#C0392B":"#27AE60"} sub={ivaNet>=0?"A ingresar":"A compensar"} onClick={()=>setSection("iva")}/>
      </div>
      <div style={{display:"flex",gap:16,flexWrap:"wrap"}}>
        <div style={{flex:2,minWidth:300,background:"#fff",borderRadius:10,padding:20,border:"1px solid #E4E9F0"}}>
          <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>IVA por trimestre</div>
          {qd.map((q,i)=><div key={i} style={{marginBottom:14}}>
            <div style={{display:"flex",justifyContent:"space-between",fontSize:12,color:"#2C3E50",marginBottom:4}}>
              <span style={{fontWeight:700}}>{q.q}</span>
              <span style={{fontFamily:"monospace",fontSize:11}}>Rep: {fmt(q.iR)} ¬∑ Sop: {fmt(q.iS)} ¬∑ <span style={{color:q.iR-q.iS>=0?"#C0392B":"#27AE60",fontWeight:700}}>{fmt(q.iR-q.iS)}</span></span>
            </div>
            <div style={{display:"flex",gap:3,height:10,borderRadius:5,overflow:"hidden",background:"#F0F2F5"}}>
              <div style={{width:`${Math.max(4,(q.iR/Math.max(tIR,1))*100)}%`,background:"#3D7A4A",borderRadius:5}}/>
              <div style={{width:`${Math.max(4,(q.iS/Math.max(tGI,1))*100)}%`,background:"#A9DFBF",borderRadius:5}}/>
            </div>
          </div>)}
        </div>
        <div style={{flex:1,minWidth:240,background:"#fff",borderRadius:10,padding:20,border:"1px solid #E4E9F0"}}>
          <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Gastos por categor√≠a</div>
          {catS.map(([cat,val],i)=><div key={i} style={{marginBottom:10}}>
            <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:"#2C3E50",marginBottom:3}}><span>{cat}</span><span style={{fontFamily:"monospace",fontWeight:600,color:"#3D7A4A"}}>{fmt(val)}</span></div>
            <div style={{height:6,borderRadius:3,background:"#F0F2F5"}}><div style={{width:`${(val/maxC)*100}%`,height:"100%",borderRadius:3,background:cc[i%cc.length]}}/></div>
          </div>)}
        </div>
      </div>
      <div style={{background:"#fff",borderRadius:10,padding:20,border:"1px solid #E4E9F0",cursor:"pointer"}} onClick={()=>setSection("alertas")}>
        <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:12,fontWeight:700}}>Alertas ({ALERTAS.length}) ‚Äî clic para ver detalle</div>
        {ALERTAS.slice(0,3).map((a,i)=><div key={i} style={{display:"flex",gap:10,alignItems:"center",padding:"6px 0",fontSize:12,color:"#2C3E50"}}><Badge type={a.tipo}>{a.tipo}</Badge><span>{a.msg}</span></div>)}
        {ALERTAS.length>3&&<div style={{fontSize:11,color:"#7A8DA0",marginTop:6}}>+{ALERTAS.length-3} m√°s...</div>}
      </div>
    </div>;
    if(section==="emitidas") return <div>
      <div style={{display:"flex",gap:14,marginBottom:18,flexWrap:"wrap"}}>
        <KPI label="Total facturado" value={fmt(tIB)} sub={`${emitidas.length} facturas`}/>
        <KPI label="IVA repercutido" value={fmt(tIR)} color="#2980B9"/>
        <KPI label="Exentas / No sujetas" value={fmt(sum(emitidas.filter(e=>e.tipoIva===0),"base"))} color="#8E44AD" sub="Art.20.9, 20.1.10¬∫, 69"/>
      </div>
      <div className="action-bar no-print">
        <button className="btn btn-primary" onClick={()=>setModalEmitida({})}>+ Nueva factura</button>
        <button className="btn btn-export" onClick={exportEmitidas}>‚Üì Exportar CSV</button>
        <div style={{flex:1}}/>
        <input className="search-input" placeholder="Buscar por n¬∫, cliente, desc..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      <DataTable maxH={420} columns={[
        {label:"N¬∫",key:"num",nowrap:true,bold:true},
        {label:"Fecha",render:r=>fmtDate(r.fecha),nowrap:true},
        {label:"Cliente",key:"cliente"},
        {label:"Descripci√≥n",key:"desc"},
        {label:"Base",align:"right",mono:true,render:r=>fmt(r.base)},
        {label:"IVA%",align:"center",render:r=>r.tipoIva?`${r.tipoIva}%`:<Badge type="info">exento</Badge>},
        {label:"IVA",align:"right",mono:true,render:r=>r.iva?fmt(r.iva):"‚Äî"},
        {label:"Total",align:"right",mono:true,bold:true,color:"#2E6B3A",render:r=>fmt(r.total)},
        {label:"T",key:"trimestre",align:"center",nowrap:true},
        {label:"PDF",align:"center",render:r=>r.doc?<a href={r.doc} target="_blank" rel="noopener" style={{color:"#2980B9",textDecoration:"none",fontWeight:700,fontSize:14}} title="Ver factura">üìÑ</a>:<span style={{color:"#ccc"}}>‚Äî</span>},
      ]} data={filteredEmitidas} onEdit={item=>setModalEmitida(item)} onDelete={item=>setConfirmDelete({type:"emitida",item})}/>
    </div>;
    if(section==="recibidas") return <div>
      <div style={{display:"flex",gap:14,marginBottom:18,flexWrap:"wrap"}}>
        <KPI label="Total gastos" value={fmt(tGB)} sub={`${recibidas.length} facturas`} color="#C0392B"/>
        <KPI label="IVA soportado" value={fmt(tGI)} color="#2980B9"/>
        <KPI label="Mayor gasto" value={catS[0]?.[0]||"‚Äî"} sub={catS[0]?fmt(catS[0][1]):""} color="#E67E22"/>
      </div>
      <div className="action-bar no-print">
        <button className="btn btn-primary" onClick={()=>setModalRecibida({})}>+ Nueva factura</button>
        <button className="btn btn-export" onClick={exportRecibidas}>‚Üì Exportar CSV</button>
        <div style={{flex:1}}/>
        <input className="search-input" placeholder="Buscar por proveedor, desc, categor√≠a..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      <DataTable maxH={420} columns={[
        {label:"Fecha",render:r=>fmtDate(r.fecha),nowrap:true},
        {label:"Proveedor",render:r=>r.prov||r.proveedor},
        {label:"Descripci√≥n",key:"desc"},
        {label:"Base",align:"right",mono:true,render:r=>fmt(r.base)},
        {label:"IVA%",align:"center",render:r=>r.tipoIva?`${r.tipoIva}%`:"‚Äî"},
        {label:"IVA",align:"right",mono:true,render:r=>r.iva?fmt(r.iva):"‚Äî"},
        {label:"Total",align:"right",mono:true,bold:true,color:"#C0392B",render:r=>fmt(r.total)},
        {label:"Cat.",render:r=><Badge type={r.cat==="Vinculada"?"warning":r.cat==="Equipos"?"success":"info"}>{r.cat}</Badge>},
        {label:"T",key:"trimestre",align:"center",nowrap:true},
        {label:"PDF",align:"center",render:r=>r.doc?<a href={r.doc} target="_blank" rel="noopener" style={{color:"#2980B9",textDecoration:"none",fontWeight:700,fontSize:14}} title="Ver factura">üìÑ</a>:<span style={{color:"#ccc"}}>‚Äî</span>},
      ]} data={filteredRecibidas} onEdit={item=>setModalRecibida(item)} onDelete={item=>setConfirmDelete({type:"recibida",item})}/>
    </div>;
    const ivaDocsMap = {
      2024: {
        Q1: [{label:"Modelo 303 ‚Äî 1T",doc:"docs/fiscal/2024/1T24.pdf"}],
        Q2: [{label:"Modelo 303 ‚Äî 2T",doc:"docs/fiscal/2024/2T24.pdf"},{label:"Borrador IVA 2T",doc:"docs/fiscal/2024/IVA_2T2024.xlsx"}],
        Q3: [{label:"Modelo 303 ‚Äî 3T",doc:"docs/fiscal/2024/IVA_Q3_2024.pdf"}],
        Q4: [{label:"Modelo 303 ‚Äî 4T",doc:"docs/fiscal/2024/IVA_Q4_2024.pdf"}],
        anual: [{label:"Modelo 390 ‚Äî Resumen anual 2024",doc:"docs/fiscal/2024/390_2024.pdf"}],
      },
      2025: {
        Q1: [{label:"Modelo 303 ‚Äî 1T",doc:"docs/fiscal/2025/1T25.pdf"}],
        Q2: [{label:"Modelo 303 ‚Äî 2T",doc:"docs/fiscal/2025/2T25.pdf"}],
        Q3: [{label:"Modelo 303 ‚Äî 3T",doc:"docs/fiscal/2025/3T25.pdf"}],
        Q4: [{label:"Modelo 303 ‚Äî 4T (rectificativa)",doc:"docs/fiscal/2025/4T25ii.pdf"},{label:"4T original",doc:"docs/fiscal/2025/4T25i.pdf"}],
        anual: [{label:"Modelo 390 ‚Äî Resumen anual 2025",doc:"docs/fiscal/2025/390_2025.pdf"}],
      },
      2023: {
        anual: [{label:"Modelo 390 ‚Äî Resumen anual 2023",doc:"docs/fiscal/2023/390_2023.pdf"}],
      },
      2022: {
        anual: [{label:"Modelo 390 ‚Äî Resumen anual 2022",doc:"docs/fiscal/2022/390_2022.pdf"}],
      },
    };
    const ivaDocs = ivaDocsMap[year]||{};
    const DocLink = ({d}) => <a href={d.doc} target="_blank" rel="noopener" style={{display:"inline-flex",alignItems:"center",gap:4,color:"#2980B9",textDecoration:"none",fontSize:11,padding:"3px 8px",background:"#EAF2F8",borderRadius:4,border:"1px solid #AED6F1"}}>üìÑ {d.label}</a>;
    const modelos303Year = MODELOS_303[year] || [];
    const hasModelos303 = modelos303Year.length > 0;
    if(section==="iva") return <div>
      <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Modelo 303 ‚Äî Liquidaci√≥n trimestral IVA {year}</div>
      {/* ‚îÄ‚îÄ‚îÄ TABLA RESUMEN OFICIAL MODELO 303 ‚îÄ‚îÄ‚îÄ */}
      {hasModelos303 && <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden",marginBottom:16}}>
        <div style={{background:"linear-gradient(135deg,#2E6B3A 0%,#3D7A4A 100%)",padding:"12px 18px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <span style={{color:"#fff",fontSize:13,fontWeight:700,letterSpacing:0.5}}>üìã Declaraciones presentadas ‚Äî Modelo 303 ({year})</span>
          <span style={{color:"rgba(255,255,255,0.8)",fontSize:11}}>NIF: B67038695 ¬∑ AZNAR LEGAL Y COMPLIANCE S L P</span>
        </div>
        <div style={{overflowX:"auto"}}>
        <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
          <thead><tr style={{background:"#F8FAF9"}}>
            {["Trim.","Presentaci√≥n","Justificante","Base Imp. 21%","IVA Devengado","Base Soportado","IVA Deducible","Resultado","Compensac.","Estado"].map((h,i)=>
              <th key={i} style={{padding:"10px 8px",textAlign:i>=3?"right":"left",fontWeight:700,color:"#2E6B3A",borderBottom:"2px solid #E4E9F0",fontSize:11,whiteSpace:"nowrap"}}>{h}</th>)}
          </tr></thead>
          <tbody>
          {modelos303Year.map((m,i)=>{
            const isExpanded = expandedIVA === m.trimestre;
            return <React.Fragment key={i}>
            <tr style={{borderBottom:"1px solid #F0F3F5",cursor:"pointer",background:isExpanded?"#F0FAF3":"transparent",transition:"background 0.15s"}} onClick={()=>setExpandedIVA(isExpanded?null:m.trimestre)}>
              <td style={{padding:"10px 8px",fontWeight:700,color:"#2E6B3A"}}><span style={{marginRight:6}}>{isExpanded?"‚ñæ":"‚ñ∏"}</span>{m.trimestre}</td>
              <td style={{padding:"10px 8px",color:"#555"}}>{m.fecha}</td>
              <td style={{padding:"10px 8px",fontFamily:"monospace",fontSize:10,color:"#7A8DA0"}}>{m.justificante}</td>
              <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace"}}>{fmt(m.baseImponible21)}</td>
              <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",color:"#C0392B",fontWeight:600}}>{fmt(m.cuotaDevengada)}</td>
              <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace"}}>{fmt(m.baseIvaSoportado)}</td>
              <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",color:"#2980B9",fontWeight:600}}>{fmt(m.cuotaDeducible)}</td>
              <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:m.resultadoRegimen>=0?"#C0392B":"#27AE60"}}>{fmt(m.resultadoRegimen)}</td>
              <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",fontSize:11,color:"#7A8DA0"}}>{m.cuotasAplicadas?fmt(m.cuotasAplicadas):"‚Äî"}</td>
              <td style={{padding:"10px 8px"}}>
                <span style={{display:"inline-block",padding:"3px 8px",borderRadius:4,fontSize:10,fontWeight:700,letterSpacing:0.3,
                  background:m.estado==="A COMPENSAR"?"#FDF2E9":m.estado==="RESULTADO 0"?"#EBF5FB":"#FDEDEC",
                  color:m.estado==="A COMPENSAR"?"#E67E22":m.estado==="RESULTADO 0"?"#2980B9":"#C0392B"
                }}>{m.estado}</span>
              </td>
            </tr>
            {isExpanded && <tr><td colSpan={10} style={{padding:0}}>
              <div style={{background:"#FAFCFB",padding:"16px 20px",borderTop:"1px dashed #C8E6C9",borderBottom:"2px solid #C8E6C9"}}>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:16,marginBottom:14}}>
                  <div style={{background:"#fff",borderRadius:8,padding:14,border:"1px solid #E4E9F0"}}>
                    <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:8}}>IVA Devengado (Casillas 07-09)</div>
                    <div style={{fontSize:12,lineHeight:2}}>
                      <div style={{display:"flex",justifyContent:"space-between"}}><span>Base imponible 21%</span><b style={{fontFamily:"monospace"}}>{fmt(m.baseImponible21)}</b></div>
                      <div style={{display:"flex",justifyContent:"space-between"}}><span>Cuota devengada [27]</span><b style={{fontFamily:"monospace",color:"#C0392B"}}>{fmt(m.cuotaDevengada)}</b></div>
                    </div>
                  </div>
                  <div style={{background:"#fff",borderRadius:8,padding:14,border:"1px solid #E4E9F0"}}>
                    <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:8}}>IVA Deducible (Casillas 28-45)</div>
                    <div style={{fontSize:12,lineHeight:2}}>
                      <div style={{display:"flex",justifyContent:"space-between"}}><span>Op. interiores corrientes [28-29]</span><b style={{fontFamily:"monospace"}}>{fmt(m.baseIvaSoportado)} ‚Üí {fmt(m.cuotaDeducible - (m.cuotaInversion||0))}</b></div>
                      {m.baseInversion && <div style={{display:"flex",justifyContent:"space-between"}}><span>Rectif. deducciones [40-41]</span><b style={{fontFamily:"monospace"}}>{fmt(m.baseInversion)} ‚Üí {fmt(m.cuotaInversion)}</b></div>}
                      <div style={{display:"flex",justifyContent:"space-between",borderTop:"1px solid #eee",paddingTop:4}}><span>Total deducible [45]</span><b style={{fontFamily:"monospace",color:"#2980B9"}}>{fmt(m.cuotaDeducible)}</b></div>
                    </div>
                  </div>
                  <div style={{background:"#fff",borderRadius:8,padding:14,border:"1px solid #E4E9F0"}}>
                    <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:8}}>Resultado y Compensaciones</div>
                    <div style={{fontSize:12,lineHeight:2}}>
                      <div style={{display:"flex",justifyContent:"space-between"}}><span>Resultado r√©gimen [46]</span><b style={{fontFamily:"monospace",color:m.resultadoRegimen>=0?"#C0392B":"#27AE60"}}>{fmt(m.resultadoRegimen)}</b></div>
                      <div style={{display:"flex",justifyContent:"space-between"}}><span>Pendientes ant. [110]</span><b style={{fontFamily:"monospace"}}>{fmt(m.cuotasPendientes)}</b></div>
                      <div style={{display:"flex",justifyContent:"space-between"}}><span>Aplicadas [78]</span><b style={{fontFamily:"monospace"}}>{m.cuotasAplicadas?fmt(m.cuotasAplicadas):"‚Äî"}</b></div>
                      <div style={{display:"flex",justifyContent:"space-between"}}><span>Pendientes post. [87]</span><b style={{fontFamily:"monospace"}}>{fmt(m.cuotasPendientesPosterior)}</b></div>
                      <div style={{display:"flex",justifyContent:"space-between",borderTop:"1px solid #eee",paddingTop:4}}><span><b>Liquidaci√≥n [71]</b></span><b style={{fontFamily:"monospace",fontSize:14,color:m.resultadoLiquidacion>=0?"#C0392B":"#27AE60"}}>{fmt(m.resultadoLiquidacion)}</b></div>
                    </div>
                  </div>
                </div>
                {m.entregasIntracom && <div style={{fontSize:11,color:"#555",marginBottom:8}}>üåç Entregas intracomunitarias [59]: <b style={{fontFamily:"monospace"}}>{fmt(m.entregasIntracom)}</b></div>}
                <div style={{display:"flex",gap:10,alignItems:"center",flexWrap:"wrap"}}>
                  <a href={m.doc} target="_blank" rel="noopener" style={{display:"inline-flex",alignItems:"center",gap:4,color:"#2980B9",textDecoration:"none",fontSize:11,padding:"4px 10px",background:"#EAF2F8",borderRadius:4,border:"1px solid #AED6F1"}}>üìÑ Ver PDF Modelo 303 ‚Äî {m.trimestre} {year}</a>
                  <span style={{fontSize:10,color:"#AAA"}}>CSV: {m.csv}</span>
                  <span style={{fontSize:10,color:"#AAA"}}>Exp: {m.expediente}</span>
                </div>
              </div>
            </td></tr>}
            </React.Fragment>;
          })}
          </tbody>
          <tfoot><tr style={{background:"#F0FAF3",borderTop:"2px solid #3D7A4A"}}>
            <td colSpan={3} style={{padding:"10px 8px",fontWeight:700,color:"#2E6B3A",fontSize:12}}>TOTAL ANUAL {year}</td>
            <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",fontWeight:700}}>{fmt(modelos303Year.reduce((s,m)=>s+m.baseImponible21,0))}</td>
            <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:"#C0392B"}}>{fmt(modelos303Year.reduce((s,m)=>s+m.cuotaDevengada,0))}</td>
            <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",fontWeight:700}}>{fmt(modelos303Year.reduce((s,m)=>s+m.baseIvaSoportado,0))}</td>
            <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:"#2980B9"}}>{fmt(modelos303Year.reduce((s,m)=>s+m.cuotaDeducible,0))}</td>
            <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:modelos303Year.reduce((s,m)=>s+m.resultadoRegimen,0)>=0?"#C0392B":"#27AE60"}}>{fmt(modelos303Year.reduce((s,m)=>s+m.resultadoRegimen,0))}</td>
            <td style={{padding:"10px 8px",textAlign:"right",fontFamily:"monospace",fontSize:11}}>{fmt(modelos303Year.reduce((s,m)=>s+(m.cuotasAplicadas||0),0))}</td>
            <td></td>
          </tr></tfoot>
        </table>
        </div>
      </div>}
      {/* ‚îÄ‚îÄ‚îÄ GR√ÅFICO IVA DEVENGADO vs DEDUCIBLE ‚îÄ‚îÄ‚îÄ */}
      {hasModelos303 && <div style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0",marginBottom:16}}>
        <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,letterSpacing:1,marginBottom:14}}>IVA Devengado vs Deducible ‚Äî Evoluci√≥n trimestral {year}</div>
        {(()=>{
          const maxVal = Math.max(...modelos303Year.map(m=>Math.max(m.cuotaDevengada,m.cuotaDeducible)),1);
          return <div style={{display:"flex",gap:12,alignItems:"flex-end",height:140}}>
            {modelos303Year.map((m,i)=><div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:4}}>
              <div style={{display:"flex",gap:3,alignItems:"flex-end",height:100,width:"100%",justifyContent:"center"}}>
                <div style={{width:"35%",background:"linear-gradient(180deg,#C0392B,#E74C3C)",borderRadius:"4px 4px 0 0",height:`${Math.max(4,(m.cuotaDevengada/maxVal)*100)}%`,transition:"height 0.3s"}} title={`Devengado: ${fmt(m.cuotaDevengada)}`}/>
                <div style={{width:"35%",background:"linear-gradient(180deg,#2471A3,#2980B9)",borderRadius:"4px 4px 0 0",height:`${Math.max(4,(m.cuotaDeducible/maxVal)*100)}%`,transition:"height 0.3s"}} title={`Deducible: ${fmt(m.cuotaDeducible)}`}/>
              </div>
              <div style={{fontSize:11,fontWeight:700,color:"#2E6B3A"}}>{m.trimestre}</div>
              <div style={{fontSize:9,color:"#999",fontFamily:"monospace"}}>{fmt(m.resultadoRegimen)}</div>
            </div>)}
          </div>;
        })()}
        <div style={{display:"flex",gap:16,justifyContent:"center",marginTop:10,fontSize:11}}>
          <span><span style={{display:"inline-block",width:10,height:10,background:"#C0392B",borderRadius:2,marginRight:4}}/>Devengado</span>
          <span><span style={{display:"inline-block",width:10,height:10,background:"#2980B9",borderRadius:2,marginRight:4}}/>Deducible</span>
        </div>
      </div>}
      {/* ‚îÄ‚îÄ‚îÄ DATOS CALCULADOS DESDE FACTURAS (fallback si no hay 303) ‚îÄ‚îÄ‚îÄ */}
      {!hasModelos303 && <React.Fragment>
        {qd.map((q,i)=><div key={i} style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0",marginBottom:12}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
            <span style={{fontSize:14,fontWeight:700,color:"#2E6B3A"}}>{q.q}</span>
            <span style={{fontSize:14,fontFamily:"monospace",fontWeight:700,color:q.iR-q.iS>=0?"#C0392B":"#27AE60"}}>{fmt(q.iR-q.iS)}</span>
          </div>
          <div style={{display:"flex",gap:20,fontSize:12,color:"#2C3E50",marginBottom:8}}>
            <span>Base emitidas: <b style={{fontFamily:"monospace"}}>{fmt(q.bE)}</b></span>
            <span>IVA repercutido: <b style={{fontFamily:"monospace",color:"#3D7A4A"}}>{fmt(q.iR)}</b></span>
            <span>Base recibidas: <b style={{fontFamily:"monospace"}}>{fmt(q.bR)}</b></span>
            <span>IVA soportado: <b style={{fontFamily:"monospace",color:"#2980B9"}}>{fmt(q.iS)}</b></span>
          </div>
          {(ivaDocs[q.q]||[]).length>0&&<div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:6}}>
            {ivaDocs[q.q].map((d,j)=><DocLink key={j} d={d}/>)}
          </div>}
          {!ivaDocs[q.q]&&<div style={{fontSize:11,color:"#ccc",marginTop:4,fontStyle:"italic"}}>Sin declaraci√≥n presentada</div>}
        </div>)}
        <div style={{background:"#fff",borderRadius:10,padding:18,border:"2px solid #3D7A4A",marginBottom:12}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
            <span style={{fontSize:14,fontWeight:700,color:"#2E6B3A"}}>TOTAL {year}</span>
            <span style={{fontSize:16,fontFamily:"monospace",fontWeight:700,color:ivaNet>=0?"#C0392B":"#27AE60"}}>{fmt(ivaNet)}</span>
          </div>
          <div style={{display:"flex",gap:20,fontSize:12,color:"#2C3E50"}}>
            <span>Total repercutido: <b style={{fontFamily:"monospace",color:"#3D7A4A"}}>{fmt(tIR)}</b></span>
            <span>Total soportado: <b style={{fontFamily:"monospace",color:"#2980B9"}}>{fmt(tGI)}</b></span>
          </div>
          {(ivaDocs.anual||[]).length>0&&<div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:8}}>
            {ivaDocs.anual.map((d,j)=><DocLink key={j} d={d}/>)}
          </div>}
        </div>
      </React.Fragment>}
      {/* ‚îÄ‚îÄ‚îÄ NOTAS IVA ‚îÄ‚îÄ‚îÄ */}
      <div style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0"}}>
        <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:8,fontWeight:700}}>Notas IVA</div>
        <div style={{fontSize:12,color:"#2C3E50",lineHeight:1.8}}>
          {hasModelos303 && <span>‚Ä¢ Presentador: MARIN ASESORES TRIBUTARIOS, S.L. (B86995131)<br/></span>}
          ‚Ä¢ Cr√©dito IVA acumulado por compensaciones de ejercicios anteriores<br/>
          ‚Ä¢ Exentas art.20.9/20.1.10¬∫<br/>
          ‚Ä¢ Art.69 (Vergara): no sujetas ¬∑ USA (Gamma, Logically): inversi√≥n sujeto pasivo 12-13
        </div>
      </div>
      {/* ‚îÄ‚îÄ‚îÄ MODELO 390 ‚Äî RESUMEN ANUAL ‚îÄ‚îÄ‚îÄ */}
      {MODELOS_390[year] && (()=>{
        const m390 = MODELOS_390[year];
        return <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden",marginTop:16}}>
          <div style={{background:"linear-gradient(135deg,#1A5276 0%,#2471A3 100%)",padding:"12px 18px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <span style={{color:"#fff",fontSize:13,fontWeight:700,letterSpacing:0.5}}>üìä Modelo 390 ‚Äî Declaraci√≥n-Resumen Anual IVA {year}</span>
            <span style={{color:"rgba(255,255,255,0.8)",fontSize:11}}>Presentado: {m390.fecha} ¬∑ Just. {m390.justificante}</span>
          </div>
          <div style={{padding:18}}>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:14,marginBottom:16}}>
              <div style={{background:"#FAFBFC",borderRadius:8,padding:14,border:"1px solid #E4E9F0",textAlign:"center"}}>
                <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:6}}>Total Operaciones</div>
                <div style={{fontSize:18,fontWeight:700,fontFamily:"monospace",color:"#2C3E50"}}>{fmt(m390.totalOperaciones)}</div>
              </div>
              <div style={{background:"#FAFBFC",borderRadius:8,padding:14,border:"1px solid #E4E9F0",textAlign:"center"}}>
                <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:6}}>IVA Devengado</div>
                <div style={{fontSize:18,fontWeight:700,fontFamily:"monospace",color:"#C0392B"}}>{fmt(m390.ivaDevengado)}</div>
              </div>
              <div style={{background:"#FAFBFC",borderRadius:8,padding:14,border:"1px solid #E4E9F0",textAlign:"center"}}>
                <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:6}}>IVA Deducible</div>
                <div style={{fontSize:18,fontWeight:700,fontFamily:"monospace",color:"#2980B9"}}>{fmt(m390.ivaSoportado)}</div>
              </div>
              <div style={{background:"#FAFBFC",borderRadius:8,padding:14,border:"1px solid #E4E9F0",textAlign:"center"}}>
                <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:6}}>Resultado Final</div>
                <div style={{fontSize:18,fontWeight:700,fontFamily:"monospace",color:m390.resultadoFinal>=0?"#C0392B":"#27AE60"}}>{fmt(m390.resultadoFinal)}</div>
                <span style={{display:"inline-block",marginTop:4,padding:"2px 8px",borderRadius:4,fontSize:10,fontWeight:700,
                  background:m390.estado==="A COMPENSAR"?"#FDF2E9":"#FDEDEC",
                  color:m390.estado==="A COMPENSAR"?"#E67E22":"#C0392B"
                }}>{m390.estado}</span>
              </div>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14,marginBottom:14}}>
              <div style={{fontSize:12,lineHeight:2,color:"#2C3E50"}}>
                <div style={{display:"flex",justifyContent:"space-between"}}><span>Base imponible 21%</span><b style={{fontFamily:"monospace"}}>{fmt(m390.baseImponible21)}</b></div>
                <div style={{display:"flex",justifyContent:"space-between"}}><span>Operaciones exentas / no sujetas</span><b style={{fontFamily:"monospace"}}>{fmt(m390.baseExenta)}</b></div>
                <div style={{display:"flex",justifyContent:"space-between",borderTop:"1px solid #eee",paddingTop:4}}><span><b>Resultado r√©gimen general [65]</b></span><b style={{fontFamily:"monospace",color:m390.resultadoRegimen>=0?"#C0392B":"#27AE60"}}>{fmt(m390.resultadoRegimen)}</b></div>
              </div>
              <div style={{fontSize:12,lineHeight:2,color:"#2C3E50"}}>
                <div style={{display:"flex",justifyContent:"space-between"}}><span>Compensaciones aplicadas</span><b style={{fontFamily:"monospace"}}>{m390.compensacionesAnteriores?fmt(m390.compensacionesAnteriores):"‚Äî"}</b></div>
                <div style={{display:"flex",justifyContent:"space-between",borderTop:"1px solid #eee",paddingTop:4}}><span><b>Liquidaci√≥n final</b></span><b style={{fontFamily:"monospace",fontSize:14,color:m390.resultadoFinal>=0?"#C0392B":"#27AE60"}}>{fmt(m390.resultadoFinal)}</b></div>
              </div>
            </div>
            <a href={m390.doc} target="_blank" rel="noopener" style={{display:"inline-flex",alignItems:"center",gap:4,color:"#1A5276",textDecoration:"none",fontSize:11,padding:"4px 10px",background:"#EAF2F8",borderRadius:4,border:"1px solid #AED6F1"}}>üìÑ Ver PDF Modelo 390 ‚Äî {year}</a>
          </div>
        </div>;
      })()}
    </div>;
    const isDocsMap = {
      2024: [
        {label:"Modelo 200 ‚Äî IS 2024",doc:"docs/fiscal/2024/IS2024.pdf"},
        {label:"Justificante pago a cuenta IS",doc:"docs/fiscal/2024/Justificante_pago_a_cuenta_IS_22024.pdf"},
        {label:"Liquidaci√≥n pago a cuenta IS",doc:"docs/fiscal/2024/Liquidacio_n_Pago_a_cuenta_IS_2024.pdf"},
        {label:"Pago Mod.010 ‚Äî 248,22‚Ç¨",doc:"docs/fiscal/2025/082615305105DC5LNA45CZ.pdf"},
      ],
      2025: [
        {label:"Requerimiento AEAT",doc:"docs/fiscal/2025/Requerimiento_2025.pdf"},
        {label:"Recibo contestaci√≥n requerimiento",doc:"docs/fiscal/2025/Eecibo_contestacio_n_requerimiento.pdf"},
        {label:"174545437Z26",doc:"docs/fiscal/2025/174545437Z26.pdf"},
        {label:"174545437Z",doc:"docs/fiscal/2025/174545437Z.pdf"},
      ],
      2022: [
        {label:"Modelo 200 ‚Äî IS 2022",doc:"docs/fiscal/2022/IS2022.pdf"},
      ],
      2023: [
        {label:"Modelo 200 ‚Äî IS 2023",doc:"docs/fiscal/2023/IS2023.pdf"},
      ],
    };
    const isDocs = isDocsMap[year]||[];
    const m200 = MODELO_200[year];
    if(section==="is") return <div>
      <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Impuesto sobre Sociedades ‚Äî {m200?"Modelo 200":"C√°lculo desde libros"} {year}</div>
      <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden"}}>
        {(m200?[
          {l:"Cifra de negocios (Mod. 200)",v:m200.cifraNegocios,b:true},
          ...emitidas.reduce((a,e)=>{const x=a.find(i=>i.l===e.cliente);if(x)x.v+=e.base;else a.push({l:e.cliente,v:e.base,i:1});return a;},[]),
          {l:"Gastos de explotaci√≥n (Mod. 200)",v:m200.gastosExplotacion,b:true,c:"#C0392B"},
          ...catS.map(([cat,val])=>({l:cat,v:-val,i:1,c:"#C0392B"})),
          {l:"Amortizaci√≥n",v:m200.amortizacion,c:"#C0392B"},
          {l:"RESULTADO DE EXPLOTACI√ìN",v:m200.resultadoExplotacion,b:true,c:m200.resultadoExplotacion>=0?"#27AE60":"#C0392B",sep:true},
          {l:"RESULTADO ANTES DE IMPUESTOS",v:m200.resultadoAntesIS,b:true,c:m200.resultadoAntesIS>=0?"#27AE60":"#C0392B"},
          {l:"Gasto IS contable (cta. 630)",v:-m200.gastoIS,c:"#C0392B"},
          {l:"RESULTADO DEL EJERCICIO",v:m200.resultadoEjercicio,b:true,c:m200.resultadoEjercicio>=0?"#27AE60":"#C0392B",sep:true},
          {l:"Base imponible antes compensaci√≥n BIN",v:m200.baseImponibleAntesComp},
          {l:"Compensaci√≥n BIN periodos anteriores",v:-m200.compensacionBIN,c:"#7A8DA0"},
          {l:"BASE IMPONIBLE",v:m200.baseImponible,b:true},
          {l:"Tipo gravamen",v:null,extra:m200.tipoGravamen+"%"},
          {l:"Cuota √≠ntegra",v:m200.cuotaIntegra,b:true,c:"#3D7A4A"},
          {l:m200.cuotaCero?"CUOTA CERO":"L√≠quido a ingresar",v:m200.liquidoIngresar,b:true,c:"#3D7A4A",sep:true},
        ]:[
          {l:"Ingresos de explotaci√≥n",v:tIB,b:true},
          ...emitidas.reduce((a,e)=>{const x=a.find(i=>i.l===e.cliente);if(x)x.v+=e.base;else a.push({l:e.cliente,v:e.base,i:1});return a;},[]),
          {l:"Gastos de explotaci√≥n",v:-tGB,b:true,c:"#C0392B"},
          ...catS.map(([cat,val])=>({l:cat,v:-val,i:1,c:"#C0392B"})),
          {l:"RESULTADO ANTES DE IMPUESTOS",v:resultado,b:true,c:resultado>=0?"#27AE60":"#C0392B",sep:true},
          {l:"Tipo IS (est. 25%)",v:null},
          {l:"Cuota IS",v:resultado>0?resultado*0.25:0,b:true,c:"#3D7A4A"},
        ]).map((r,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"10px 20px",paddingLeft:20+(r.i||0)*24,borderTop:r.sep?"2px solid #3D7A4A":i>0?"1px solid #F0F2F5":"none",background:r.b&&!r.i?"#FAFBFC":"#fff"}}>
          <span style={{fontSize:12,color:r.b?"#2C3E50":"#7A8DA0",fontWeight:r.b?700:400}}>{r.l}</span>
          <span style={{fontSize:12,fontFamily:"monospace",color:r.c||"#2C3E50",fontWeight:r.b?700:400}}>{r.extra||(r.v!=null?fmt(Math.abs(r.v)):"")}</span>
        </div>)}
      </div>
      {isDocs.length>0&&<div style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0",marginTop:16}}>
        <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:10,fontWeight:700}}>Documentos IS / AEAT ‚Äî {year}</div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
          {isDocs.map((d,j)=><DocLink key={j} d={d}/>)}
        </div>
      </div>}
    </div>;
    if(section==="reconciliacion") {
      const vatData = vatEngine(emitidas, recibidas, year);
      const hasAny303 = (MODELOS_303[year]||[]).length > 0;
      const totCalc = vatData.reduce((t,q) => ({base21:t.base21+q.calc.base21, cuotaDev:t.cuotaDev+q.calc.cuotaDev, baseSop:t.baseSop+q.calc.baseSop, cuotaDed:t.cuotaDed+q.calc.cuotaDed, resultado:t.resultado+q.calc.resultado}), {base21:0,cuotaDev:0,baseSop:0,cuotaDed:0,resultado:0});
      const totAeat = hasAny303 ? vatData.reduce((t,q) => ({base21:t.base21+(q.aeat.base21||0), cuotaDev:t.cuotaDev+(q.aeat.cuotaDev||0), baseSop:t.baseSop+(q.aeat.baseSop||0), cuotaDed:t.cuotaDed+(q.aeat.cuotaDed||0), resultado:t.resultado+(q.aeat.resultado||0)}), {base21:0,cuotaDev:0,baseSop:0,cuotaDed:0,resultado:0}) : null;
      const DeltaCell = ({v}) => v === null ? <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontSize:11,color:"#ccc"}}>‚Äî</td> : <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontSize:11,fontWeight:Math.abs(v)>0.01?700:400,color:Math.abs(v)<0.01?"#27AE60":Math.abs(v)<1?"#E67E22":"#C0392B"}}>{Math.abs(v)<0.01?"‚úì":v>0?"+"+fmt(v):fmt(v)}</td>;
      const allSuspicious = vatData.flatMap(q => q.suspicious.map(s => ({...s, trimestre: q.q})));
      // Score
      const totalDeltas = vatData.filter(q=>q.hasAeat);
      const matchCount = totalDeltas.filter(q => Math.abs(q.delta.cuotaDev)<0.02 && Math.abs(q.delta.cuotaDed)<0.02).length;
      const score = totalDeltas.length > 0 ? Math.round((matchCount / totalDeltas.length) * 100) : null;
      const scoreColor = score === null ? "#999" : score === 100 ? "#27AE60" : score >= 75 ? "#E67E22" : "#C0392B";
      return <div>
        <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Motor de Reconciliaci√≥n IVA ‚Äî Facturas vs AEAT {year}</div>
        {/* ‚îÄ‚îÄ‚îÄ SCORE ‚îÄ‚îÄ‚îÄ */}
        <div style={{display:"flex",gap:14,marginBottom:16}}>
          <div style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0",flex:1,textAlign:"center"}}>
            <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:8}}>√çndice de Reconciliaci√≥n</div>
            <div style={{fontSize:36,fontWeight:700,fontFamily:"monospace",color:scoreColor}}>{score !== null ? score+"%" : "N/A"}</div>
            <div style={{fontSize:11,color:"#7A8DA0",marginTop:4}}>{score === 100 ? "Facturas ‚Üî AEAT cuadran perfectamente" : score !== null ? matchCount+"/"+totalDeltas.length+" trimestres reconciliados" : "Sin datos AEAT para comparar"}</div>
          </div>
          <div style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0",flex:1,textAlign:"center"}}>
            <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:8}}>Œî IVA Devengado (anual)</div>
            <div style={{fontSize:24,fontWeight:700,fontFamily:"monospace",color:totAeat&&Math.abs(totCalc.cuotaDev-totAeat.cuotaDev)<0.02?"#27AE60":"#C0392B"}}>{totAeat?fmt(totCalc.cuotaDev-totAeat.cuotaDev):"‚Äî"}</div>
            <div style={{fontSize:11,color:"#7A8DA0",marginTop:4}}>Calc: {fmt(totCalc.cuotaDev)} | AEAT: {totAeat?fmt(totAeat.cuotaDev):"‚Äî"}</div>
          </div>
          <div style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0",flex:1,textAlign:"center"}}>
            <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:8}}>Œî IVA Deducible (anual)</div>
            <div style={{fontSize:24,fontWeight:700,fontFamily:"monospace",color:totAeat&&Math.abs(totCalc.cuotaDed-totAeat.cuotaDed)<0.02?"#27AE60":"#C0392B"}}>{totAeat?fmt(totCalc.cuotaDed-totAeat.cuotaDed):"‚Äî"}</div>
            <div style={{fontSize:11,color:"#7A8DA0",marginTop:4}}>Calc: {fmt(totCalc.cuotaDed)} | AEAT: {totAeat?fmt(totAeat.cuotaDed):"‚Äî"}</div>
          </div>
        </div>
        {/* ‚îÄ‚îÄ‚îÄ TABLA RECONCILIACI√ìN ‚îÄ‚îÄ‚îÄ */}
        <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden",marginBottom:16}}>
          <div style={{background:"linear-gradient(135deg,#1A5276 0%,#2471A3 100%)",padding:"12px 18px"}}>
            <span style={{color:"#fff",fontSize:13,fontWeight:700,letterSpacing:0.5}}>‚öñ Reconciliaci√≥n trimestral ‚Äî Facturas vs Modelo 303</span>
          </div>
          <div style={{overflowX:"auto"}}>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
            <thead>
              <tr style={{background:"#F8FAFB"}}>
                <th style={{padding:"8px 10px",textAlign:"left",fontWeight:700,color:"#1A5276",borderBottom:"2px solid #E4E9F0",fontSize:11}} rowSpan={2}>Trim.</th>
                <th style={{padding:"8px 10px",textAlign:"center",fontWeight:700,color:"#1A5276",borderBottom:"1px solid #E4E9F0",fontSize:10,borderLeft:"2px solid #E4E9F0"}} colSpan={3}>BASE IMPONIBLE 21%</th>
                <th style={{padding:"8px 10px",textAlign:"center",fontWeight:700,color:"#C0392B",borderBottom:"1px solid #E4E9F0",fontSize:10,borderLeft:"2px solid #E4E9F0"}} colSpan={3}>CUOTA DEVENGADA</th>
                <th style={{padding:"8px 10px",textAlign:"center",fontWeight:700,color:"#2980B9",borderBottom:"1px solid #E4E9F0",fontSize:10,borderLeft:"2px solid #E4E9F0"}} colSpan={3}>CUOTA DEDUCIBLE</th>
                <th style={{padding:"8px 10px",textAlign:"center",fontWeight:700,color:"#1A5276",borderBottom:"1px solid #E4E9F0",fontSize:10,borderLeft:"2px solid #E4E9F0"}} colSpan={3}>RESULTADO R√âGIMEN</th>
              </tr>
              <tr style={{background:"#F0F4F8"}}>
                {[...Array(4)].flatMap((_,g)=>["Calc","AEAT","Œî"].map((h,i)=>
                  <th key={g*3+i} style={{padding:"6px 8px",textAlign:"right",fontWeight:600,color:h==="Œî"?"#8E44AD":"#7A8DA0",borderBottom:"2px solid #E4E9F0",fontSize:10,borderLeft:i===0?"2px solid #E4E9F0":"none"}}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
            {vatData.map((row,i)=>{
              const anyDelta = row.hasAeat && (Math.abs(row.delta.cuotaDev)>0.01 || Math.abs(row.delta.cuotaDed)>0.01);
              return <tr key={i} style={{borderBottom:"1px solid #F0F3F5",background:anyDelta?"#FFF8F0":"transparent"}}>
                <td style={{padding:"8px 10px",fontWeight:700,color:"#1A5276"}}>{row.q}{anyDelta&&<span style={{marginLeft:6,color:"#C0392B",fontSize:10}}>‚ö†</span>}</td>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",borderLeft:"2px solid #E4E9F0"}}>{fmt(row.calc.base21)}</td>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",color:row.hasAeat?"#2C3E50":"#ccc"}}>{row.hasAeat?fmt(row.aeat.base21):"‚Äî"}</td>
                <DeltaCell v={row.delta.base21}/>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",color:"#C0392B",fontWeight:600,borderLeft:"2px solid #E4E9F0"}}>{fmt(row.calc.cuotaDev)}</td>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",color:row.hasAeat?"#C0392B":"#ccc",fontWeight:600}}>{row.hasAeat?fmt(row.aeat.cuotaDev):"‚Äî"}</td>
                <DeltaCell v={row.delta.cuotaDev}/>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",color:"#2980B9",fontWeight:600,borderLeft:"2px solid #E4E9F0"}}>{fmt(row.calc.cuotaDed)}</td>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",color:row.hasAeat?"#2980B9":"#ccc",fontWeight:600}}>{row.hasAeat?fmt(row.aeat.cuotaDed):"‚Äî"}</td>
                <DeltaCell v={row.delta.cuotaDed}/>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:row.calc.resultado>=0?"#C0392B":"#27AE60",borderLeft:"2px solid #E4E9F0"}}>{fmt(row.calc.resultado)}</td>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:row.hasAeat?(row.aeat.resultado>=0?"#C0392B":"#27AE60"):"#ccc"}}>{row.hasAeat?fmt(row.aeat.resultado):"‚Äî"}</td>
                <DeltaCell v={row.delta.resultado}/>
              </tr>;
            })}
            </tbody>
            <tfoot><tr style={{background:"#F0F4F8",borderTop:"2px solid #1A5276"}}>
              <td style={{padding:"10px",fontWeight:700,color:"#1A5276",fontSize:12}}>TOTAL</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,borderLeft:"2px solid #E4E9F0"}}>{fmt(totCalc.base21)}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700}}>{totAeat?fmt(totAeat.base21):"‚Äî"}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:totAeat&&Math.abs(totCalc.base21-totAeat.base21)<0.02?"#27AE60":"#8E44AD"}}>{totAeat?(Math.abs(totCalc.base21-totAeat.base21)<0.02?"‚úì":fmt(totCalc.base21-totAeat.base21)):"‚Äî"}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:"#C0392B",borderLeft:"2px solid #E4E9F0"}}>{fmt(totCalc.cuotaDev)}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:"#C0392B"}}>{totAeat?fmt(totAeat.cuotaDev):"‚Äî"}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:totAeat&&Math.abs(totCalc.cuotaDev-totAeat.cuotaDev)<0.02?"#27AE60":"#8E44AD"}}>{totAeat?(Math.abs(totCalc.cuotaDev-totAeat.cuotaDev)<0.02?"‚úì":fmt(totCalc.cuotaDev-totAeat.cuotaDev)):"‚Äî"}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:"#2980B9",borderLeft:"2px solid #E4E9F0"}}>{fmt(totCalc.cuotaDed)}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:"#2980B9"}}>{totAeat?fmt(totAeat.cuotaDed):"‚Äî"}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:totAeat&&Math.abs(totCalc.cuotaDed-totAeat.cuotaDed)<0.02?"#27AE60":"#8E44AD"}}>{totAeat?(Math.abs(totCalc.cuotaDed-totAeat.cuotaDed)<0.02?"‚úì":fmt(totCalc.cuotaDed-totAeat.cuotaDed)):"‚Äî"}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,borderLeft:"2px solid #E4E9F0"}}>{fmt(totCalc.resultado)}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700}}>{totAeat?fmt(totAeat.resultado):"‚Äî"}</td>
              <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,color:totAeat&&Math.abs(totCalc.resultado-totAeat.resultado)<0.02?"#27AE60":"#8E44AD"}}>{totAeat?(Math.abs(totCalc.resultado-totAeat.resultado)<0.02?"‚úì":fmt(totCalc.resultado-totAeat.resultado)):"‚Äî"}</td>
            </tr></tfoot>
          </table>
          </div>
        </div>
        {/* ‚îÄ‚îÄ‚îÄ DETALLE POR TRIMESTRE (expandible) ‚îÄ‚îÄ‚îÄ */}
        {vatData.filter(q => q.hasAeat && (Math.abs(q.delta.cuotaDev)>0.01 || Math.abs(q.delta.cuotaDed)>0.01)).map((row,i) => <div key={i} style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden",marginBottom:12}}>
          <div style={{background:"#FFF3E0",padding:"10px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <span style={{fontSize:12,fontWeight:700,color:"#E65100"}}>‚ö† {row.q} ‚Äî Discrepancia detectada</span>
            <span style={{fontSize:11,color:"#BF360C",fontFamily:"monospace"}}>Œî Devengado: {fmt(row.delta.cuotaDev)} | Œî Deducible: {fmt(row.delta.cuotaDed)}</span>
          </div>
          <div style={{padding:16,display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
            <div>
              <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:8}}>Facturas emitidas con IVA 21% ‚Äî {row.q}</div>
              {row.emitidas.filter(e=>e.tipoIva===21).length === 0 ? <div style={{fontSize:11,color:"#ccc",fontStyle:"italic"}}>Sin facturas con IVA</div> : row.emitidas.filter(e=>e.tipoIva===21).map((e,j) => <div key={j} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:11,borderBottom:"1px solid #F5F5F5"}}>
                <span style={{color:"#2C3E50"}}>{e.num} ‚Äî {e.cliente?.substring(0,30)}</span>
                <span style={{fontFamily:"monospace",color:"#C0392B"}}>{fmt(e.base)} ‚Üí {fmt(e.iva)}</span>
              </div>)}
              <div style={{display:"flex",justifyContent:"space-between",padding:"6px 0",fontSize:11,fontWeight:700,borderTop:"2px solid #eee",marginTop:4}}>
                <span>Total calc.</span><span style={{fontFamily:"monospace"}}>{fmt(row.calc.base21)} ‚Üí {fmt(row.calc.cuotaDev)}</span>
              </div>
              <div style={{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:11,color:"#1A5276"}}>
                <span>AEAT declarado</span><span style={{fontFamily:"monospace"}}>{fmt(row.aeat.base21)} ‚Üí {fmt(row.aeat.cuotaDev)}</span>
              </div>
            </div>
            <div>
              <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,marginBottom:8}}>Facturas recibidas con IVA ‚Äî {row.q}</div>
              {row.recibidas.filter(r=>r.tipoIva>0).length === 0 ? <div style={{fontSize:11,color:"#ccc",fontStyle:"italic"}}>Sin facturas con IVA</div> : row.recibidas.filter(r=>r.tipoIva>0).map((r,j) => <div key={j} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:11,borderBottom:"1px solid #F5F5F5"}}>
                <span style={{color:"#2C3E50"}}>{(r.prov||r.proveedor)?.substring(0,30)}</span>
                <span style={{fontFamily:"monospace",color:"#2980B9"}}>{fmt(r.base)} ‚Üí {fmt(r.iva)}</span>
              </div>)}
              <div style={{display:"flex",justifyContent:"space-between",padding:"6px 0",fontSize:11,fontWeight:700,borderTop:"2px solid #eee",marginTop:4}}>
                <span>Total calc.</span><span style={{fontFamily:"monospace"}}>{fmt(row.calc.baseSop)} ‚Üí {fmt(row.calc.cuotaDed)}</span>
              </div>
              <div style={{display:"flex",justifyContent:"space-between",padding:"4px 0",fontSize:11,color:"#1A5276"}}>
                <span>AEAT declarado</span><span style={{fontFamily:"monospace"}}>{fmt(row.aeat.baseSop)} ‚Üí {fmt(row.aeat.cuotaDed)}</span>
              </div>
            </div>
          </div>
        </div>)}
        {/* ‚îÄ‚îÄ‚îÄ FACTURAS SOSPECHOSAS ‚îÄ‚îÄ‚îÄ */}
        {allSuspicious.length > 0 && <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden",marginBottom:16}}>
          <div style={{background:"#FEF9E7",padding:"10px 16px",borderBottom:"1px solid #F9E79F"}}>
            <span style={{fontSize:12,fontWeight:700,color:"#7D6608"}}>üîç Facturas recibidas sin IVA que podr√≠an requerir revisi√≥n ({allSuspicious.length})</span>
          </div>
          <div style={{padding:"8px 16px"}}>
            {allSuspicious.map((s,i) => <div key={i} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",fontSize:11,borderBottom:"1px solid #F5F5F5"}}>
              <span style={{color:"#7D6608"}}>{s.trimestre} ¬∑ {s.prov||s.proveedor} ‚Äî {s.desc?.substring(0,50)}</span>
              <span style={{fontFamily:"monospace"}}>{fmt(s.base)} (IVA 0%)</span>
            </div>)}
          </div>
        </div>}
        {/* ‚îÄ‚îÄ‚îÄ NOTAS METODOL√ìGICAS ‚îÄ‚îÄ‚îÄ */}
        <div style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0"}}>
          <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:8,fontWeight:700}}>Notas del motor de reconciliaci√≥n</div>
          <div style={{fontSize:12,color:"#2C3E50",lineHeight:1.8}}>
            ‚Ä¢ <b>Columna "Calc"</b>: suma de IVA desde facturas registradas en la plataforma<br/>
            ‚Ä¢ <b>Columna "AEAT"</b>: datos oficiales del Modelo 303 presentado<br/>
            ‚Ä¢ <b>Œî (delta)</b>: diferencia Calc ‚àí AEAT. <span style={{color:"#27AE60"}}>‚úì</span> = coincide, <span style={{color:"#E67E22"}}>naranja</span> = desviaci√≥n menor, <span style={{color:"#C0392B"}}>rojo</span> = discrepancia significativa<br/>
            ‚Ä¢ Posibles causas de Œî: facturas no registradas, inversi√≥n sujeto pasivo no modelada, errores de redondeo, facturas en distinto trimestre<br/>
            ‚Ä¢ Las facturas "sospechosas" son recibidas con IVA 0% que podr√≠an requerir ISP (inversi√≥n sujeto pasivo) seg√∫n art. 84.1.2¬∫ LIVA
          </div>
        </div>
      </div>;
    }
    if(section==="alertas") return <div>
      <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:14,fontWeight:700}}>Alertas y gaps detectados</div>
      {ALERTAS.map((a,i)=><div key={i} style={{display:"flex",gap:10,alignItems:"flex-start",padding:"12px 16px",borderRadius:8,marginBottom:8,background:a.tipo==="error"?"#FDEDEC":a.tipo==="warning"?"#FEF9E7":"#EAF2F8",border:`1px solid ${a.tipo==="error"?"#F5B7B1":a.tipo==="warning"?"#F9E79F":"#AED6F1"}`}}>
        <Badge type={a.tipo}>{a.tipo}</Badge>
        <div style={{flex:1,fontSize:13,color:"#2C3E50"}}>{a.msg}</div>
        <div style={{fontSize:12,color:"#7A8DA0",minWidth:160,textAlign:"right",fontStyle:"italic"}}>{a.accion}</div>
      </div>)}
    </div>;
    if(section==="libros") {
      const allRecibidas = YEARS.flatMap(y=>store[`recibidas_${y}`]||[]);
      const asientos = generarAsientos(emitidas, recibidas, year, allRecibidas);
      const mayor = generarMayor(asientos);
      const balance = generarBalance(mayor);
      const pyg = generarPyG(mayor);
      const ccaaDoc = {2022:"docs/corporativo/CERT_DE_APROB_CCAA_2022.pdf",2021:"docs/corporativo/AZNAR_LEGALCERTIFICADO_DE_APROBACION_CCAA2021.pdf",2020:"docs/corporativo/CERTIFICACION_AZNAR_SLP_2020_copy.pdf",2019:"docs/corporativo/CERTIF__CCAA__2019__AZANAR_LEGAL_copy.pdf"};
      const yearDocs = {
        2023:[{label:"Diario 2023 (Excel)",doc:"docs/corporativo/DIARIO_2023.xlsx"}],
        2022:[{label:"Balance 2022",doc:"docs/corporativo/BCE_2022.pdf"},{label:"PyG 2022",doc:"docs/corporativo/PG_2022.pdf"},{label:"CCAA 2022",doc:ccaaDoc[2022]}],
      };
      const SectionTitle = ({children}) => <div style={{color:"#7A8DA0",fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:10,marginTop:20,fontWeight:700}}>{children}</div>;
      const tabs = [{id:"evolucion",label:"Evoluci√≥n"},{id:"diario",label:"Libro Diario"},{id:"mayor",label:"Libro Mayor"},{id:"balance",label:"Balance"},{id:"pyg",label:"PyG"},{id:"docs",label:"Documentos"}];
      return <div>
        <div style={{display:"flex",gap:6,marginBottom:16,flexWrap:"wrap"}}>
          {tabs.map(t=><button key={t.id} onClick={()=>setLibroView(libroView===t.id?null:t.id)} style={{padding:"6px 14px",borderRadius:6,border:libroView===t.id?"2px solid #3D7A4A":"1px solid #D5DCE4",background:libroView===t.id?"#3D7A4A":"#fff",color:libroView===t.id?"#fff":"#7A8DA0",cursor:"pointer",fontSize:12,fontWeight:600}}>
            {t.label}
          </button>)}
        </div>
        {(!libroView||libroView==="evolucion")&&<div>
          <SectionTitle>Evoluci√≥n patrimonial ‚Äî Aznar Legal & Compliance SLP (2017-2025)</SectionTitle>
          {/* ‚îÄ‚îÄ‚îÄ CHART: PN + 551 + INCN ‚îÄ‚îÄ‚îÄ */}
          <div style={{background:"#fff",borderRadius:10,padding:20,border:"1px solid #E4E9F0",marginBottom:16}}>
            <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,letterSpacing:1,marginBottom:16}}>Patrimonio Neto vs Cuenta 551 (Socio) vs Facturaci√≥n</div>
            {(()=>{
              const maxVal = Math.max(...EVOLUTION_DATA.filter(d=>d.totalActivo!==null).map(d=>Math.max(d.totalActivo, d.incn, d.pn, d.cta551)));
              const barH = 160;
              return <div>
                <div style={{display:"flex",gap:4,alignItems:"flex-end",height:barH+30}}>
                  {EVOLUTION_DATA.map((d,i) => {
                    const hasFull = d.pn !== null;
                    return <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:2}}>
                      {hasFull ? <div style={{display:"flex",gap:1,alignItems:"flex-end",height:barH,width:"100%",justifyContent:"center"}}>
                        <div style={{width:"20%",background:"linear-gradient(180deg,#1A5276,#2471A3)",borderRadius:"3px 3px 0 0",height:`${Math.max(3,(d.pn/maxVal)*barH)}px`,transition:"height 0.3s"}} title={`PN: ${d.pn.toLocaleString("es-ES")}‚Ç¨`}/>
                        <div style={{width:"20%",background:"linear-gradient(180deg,#C0392B,#E74C3C)",borderRadius:"3px 3px 0 0",height:`${Math.max(3,(d.cta551/maxVal)*barH)}px`,transition:"height 0.3s"}} title={`551: ${d.cta551.toLocaleString("es-ES")}‚Ç¨`}/>
                        <div style={{width:"20%",background:"linear-gradient(180deg,#27AE60,#2ECC71)",borderRadius:"3px 3px 0 0",height:`${Math.max(3,(d.incn/maxVal)*barH)}px`,transition:"height 0.3s"}} title={`INCN: ${d.incn.toLocaleString("es-ES")}‚Ç¨`}/>
                      </div> : <div style={{display:"flex",gap:1,alignItems:"flex-end",height:barH,width:"100%",justifyContent:"center"}}>
                        <div style={{width:"50%",background:"linear-gradient(180deg,#BDC3C7,#D5DBDB)",borderRadius:"3px 3px 0 0",height:`${Math.max(3,(d.incn/maxVal)*barH)}px`}} title={`INCN: ${d.incn.toLocaleString("es-ES")}‚Ç¨`}/>
                      </div>}
                      <div style={{fontSize:10,fontWeight:700,color:d.year===year?"#2E6B3A":"#7A8DA0",background:d.year===year?"#E8F5E9":"transparent",padding:"2px 4px",borderRadius:3}}>{d.year}</div>
                    </div>;
                  })}
                </div>
                <div style={{display:"flex",gap:16,justifyContent:"center",marginTop:12,fontSize:11}}>
                  <span><span style={{display:"inline-block",width:10,height:10,background:"#2471A3",borderRadius:2,marginRight:4}}/>Patrimonio Neto</span>
                  <span><span style={{display:"inline-block",width:10,height:10,background:"#E74C3C",borderRadius:2,marginRight:4}}/>551 Cta. Socio</span>
                  <span><span style={{display:"inline-block",width:10,height:10,background:"#2ECC71",borderRadius:2,marginRight:4}}/>Facturaci√≥n (INCN)</span>
                  <span><span style={{display:"inline-block",width:10,height:10,background:"#D5DBDB",borderRadius:2,marginRight:4}}/>Solo INCN (sin balance)</span>
                </div>
              </div>;
            })()}
          </div>
          {/* ‚îÄ‚îÄ‚îÄ TABLE: All years ‚îÄ‚îÄ‚îÄ */}
          <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden",marginBottom:16}}>
            <div style={{background:"linear-gradient(135deg,#1A5276 0%,#2471A3 100%)",padding:"12px 18px"}}>
              <span style={{color:"#fff",fontSize:13,fontWeight:700,letterSpacing:0.5}}>üìä Magnitudes clave por ejercicio</span>
            </div>
            <div style={{overflowX:"auto"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}>
              <thead><tr style={{background:"#F8FAFB"}}>
                {["A√±o","Total Activo","Patrim. Neto","Resultado","INCN","551 Socio","Tesorer√≠a","Clientes","HP Deudora","Fuente"].map((h,i)=>
                  <th key={i} style={{padding:"8px 6px",textAlign:i>=1&&i<=8?"right":"left",fontWeight:700,color:"#1A5276",borderBottom:"2px solid #E4E9F0",fontSize:10,whiteSpace:"nowrap"}}>{h}</th>)}
              </tr></thead>
              <tbody>
              {EVOLUTION_DATA.map((d,i)=>{
                const f = v => v !== null ? v.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})+" ‚Ç¨" : <span style={{color:"#ccc"}}>n/d</span>;
                return <tr key={i} style={{borderBottom:"1px solid #F0F3F5",background:d.year===year?"#E8F5E9":"transparent"}}>
                  <td style={{padding:"8px 6px",fontWeight:700,color:d.year===year?"#2E6B3A":"#1A5276"}}>{d.year}</td>
                  <td style={{padding:"8px 6px",textAlign:"right",fontFamily:"monospace"}}>{f(d.totalActivo)}</td>
                  <td style={{padding:"8px 6px",textAlign:"right",fontFamily:"monospace",color:"#2471A3",fontWeight:600}}>{f(d.pn)}</td>
                  <td style={{padding:"8px 6px",textAlign:"right",fontFamily:"monospace",fontWeight:600,color:d.resultado!==null?(d.resultado>=0?"#27AE60":"#C0392B"):"#ccc"}}>{f(d.resultado)}</td>
                  <td style={{padding:"8px 6px",textAlign:"right",fontFamily:"monospace",color:"#2E6B3A"}}>{f(d.incn)}</td>
                  <td style={{padding:"8px 6px",textAlign:"right",fontFamily:"monospace",color:d.cta551>0?"#C0392B":"#ccc",fontWeight:d.cta551>0?700:400}}>{f(d.cta551)}</td>
                  <td style={{padding:"8px 6px",textAlign:"right",fontFamily:"monospace"}}>{f(d.tesoreria)}</td>
                  <td style={{padding:"8px 6px",textAlign:"right",fontFamily:"monospace"}}>{f(d.clientes)}</td>
                  <td style={{padding:"8px 6px",textAlign:"right",fontFamily:"monospace"}}>{f(d.hpDeudora)}</td>
                  <td style={{padding:"8px 6px",fontSize:9,color:"#7A8DA0",maxWidth:120}}>{d.fuente}</td>
                </tr>;
              })}
              </tbody>
            </table>
            </div>
          </div>
          {/* ‚îÄ‚îÄ‚îÄ 551 ACCOUNT NARRATIVE ‚îÄ‚îÄ‚îÄ */}
          <div style={{background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0",marginBottom:16}}>
            <div style={{fontSize:10,color:"#7A8DA0",textTransform:"uppercase",fontWeight:700,letterSpacing:1,marginBottom:10}}>551 ‚Äî Cuenta corriente con socios y administradores</div>
            <div style={{fontSize:12,color:"#2C3E50",lineHeight:1.8}}>
              <b>2017-2018:</b> Saldo 0. La SLP ten√≠a caja de sobra (71K‚Üí17K) y pagaba sus gastos desde Bankinter.<br/>
              <b>2019-2021:</b> Facturaci√≥n se reduce a ~2K/a√±o. Enrique empieza a pagar gastos con tarjeta personal. Sin Modelo 200 disponible para estos a√±os.<br/>
              <b>2022:</b> Aparece por primera vez: <b style={{color:"#C0392B"}}>17.421,71‚Ç¨</b>. Acumulaci√≥n de gastos pagados personalmente 2019-2022.<br/>
              <b>2023:</b> <b style={{color:"#C0392B"}}>16.579,25‚Ç¨</b> (IS oficial). Qonto no contabilizada ‚Äî aportaci√≥n de 6.090‚Ç¨ no reflejada.<br/>
              <b>2024:</b> <b style={{color:"#27AE60"}}>0‚Ç¨</b> en IS oficial ‚Äî <span style={{color:"#C0392B"}}>ERROR en Modelo 200</span>. Deber√≠a ser ‚â•23.512‚Ç¨.<br/>
              <b>2025:</b> <b style={{color:"#C0392B"}}>29.898,95‚Ç¨</b> (sustitutiva). Reconstruido con Bankinter+Qonto verificados.
            </div>
          </div>
          {/* ‚îÄ‚îÄ‚îÄ NOTES ‚îÄ‚îÄ‚îÄ */}
          <div style={{background:"#FEF9E7",borderRadius:10,padding:18,border:"1px solid #F9E79F"}}>
            <div style={{fontSize:10,color:"#7D6608",textTransform:"uppercase",fontWeight:700,letterSpacing:1,marginBottom:8}}>Notas sobre datos incompletos</div>
            <div style={{fontSize:12,color:"#7D6608",lineHeight:1.8}}>
              ‚Ä¢ 2019-2021: solo se dispone de la cifra de negocios (INCN) desde certificaciones de aprobaci√≥n de CCAA. Los Modelos 200 existen (IS_200_2019.pdf, IS2020.pdf, IS2021.pdf) pero no se han integrado a√∫n.<br/>
              ‚Ä¢ 2024: el IS oficial no refleja Qonto ni la 551 real. El balance depositado diferir√° del Modelo 200.<br/>
              ‚Ä¢ 2025: datos sustitutivos pendientes de cierre definitivo y presentaci√≥n del Modelo 200.
            </div>
          </div>
        </div>}
        {(libroView==="diario")&&<div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
            <SectionTitle>Libro diario ‚Äî {year} ({asientos.length} asientos)</SectionTitle>
            <button className="btn btn-sm btn-export" onClick={()=>{
              const rows=[];asientos.forEach(a=>{a.apuntes.forEach((ap,j)=>{rows.push({n:j===0?a.n:"",fecha:j===0?a.fecha:"",tipo:j===0?a.tipo:"",concepto:j===0?a.concepto:"",cuenta:ap.nombre,debe:ap.debe||"",haber:ap.haber||""});});});
              exportCSV(rows,`libro_diario_${year}.csv`,[{label:"N¬∫",key:"n"},{label:"Fecha",key:"fecha"},{label:"Tipo",key:"tipo"},{label:"Concepto",key:"concepto"},{label:"Cuenta",key:"cuenta"},{label:"Debe",key:"debe"},{label:"Haber",key:"haber"}]);
            }}>‚Üì CSV</button>
          </div>
          <div style={{overflowX:"auto",overflowY:"auto",maxHeight:500,borderRadius:8,border:"1px solid #E4E9F0",background:"#fff"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11,fontFamily:"system-ui"}}>
              <thead><tr>
                {["N¬∫","Fecha","Tipo","Concepto","Cuenta","Debe","Haber"].map((h,i)=><th key={i} style={{padding:"8px 10px",textAlign:i>=5?"right":"left",color:"#7A8DA0",fontSize:9,textTransform:"uppercase",letterSpacing:0.5,borderBottom:"2px solid #3D7A4A",background:"#FAFBFC",position:"sticky",top:0,whiteSpace:"nowrap",fontWeight:700}}>{h}</th>)}
              </tr></thead>
              <tbody>{asientos.flatMap((a,ai)=>a.apuntes.map((ap,j)=><tr key={`${ai}-${j}`} style={{background:j===0&&a.tipo==="AM"?"#FEF9E7":"transparent"}}>
                <td style={{padding:"5px 10px",borderBottom:"1px solid #F0F2F5",fontWeight:j===0?600:400,color:"#2C3E50",fontSize:10}}>{j===0?a.n:""}</td>
                <td style={{padding:"5px 10px",borderBottom:"1px solid #F0F2F5",whiteSpace:"nowrap",fontSize:10,color:"#7A8DA0"}}>{j===0?fmtDate(a.fecha):""}</td>
                <td style={{padding:"5px 10px",borderBottom:"1px solid #F0F2F5"}}>{j===0?<Badge type={a.tipo==="FE"?"success":a.tipo==="FR"?"warning":"info"}>{a.tipo}</Badge>:""}</td>
                <td style={{padding:"5px 10px",borderBottom:"1px solid #F0F2F5",fontSize:10,color:j===0?"#2C3E50":"#999",paddingLeft:j>0?30:10}}>{j===0?a.concepto:""}</td>
                <td style={{padding:"5px 10px",borderBottom:"1px solid #F0F2F5",fontSize:10,color:"#2C3E50",fontWeight:500}}>{ap.nombre}</td>
                <td style={{padding:"5px 10px",borderBottom:"1px solid #F0F2F5",textAlign:"right",fontFamily:"monospace",fontSize:10,color:ap.debe?"#2C3E50":"#ccc"}}>{ap.debe?fmt(ap.debe):""}</td>
                <td style={{padding:"5px 10px",borderBottom:"1px solid #F0F2F5",textAlign:"right",fontFamily:"monospace",fontSize:10,color:ap.haber?"#2C3E50":"#ccc"}}>{ap.haber?fmt(ap.haber):""}</td>
              </tr>))}</tbody>
              <tfoot><tr style={{background:"#FAFBFC"}}>
                <td colSpan={5} style={{padding:"8px 10px",fontWeight:700,fontSize:11,borderTop:"2px solid #3D7A4A"}}>TOTALES</td>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,fontSize:11,borderTop:"2px solid #3D7A4A"}}>{fmt(asientos.reduce((s,a)=>s+a.apuntes.reduce((s2,ap)=>s2+ap.debe,0),0))}</td>
                <td style={{padding:"8px 10px",textAlign:"right",fontFamily:"monospace",fontWeight:700,fontSize:11,borderTop:"2px solid #3D7A4A"}}>{fmt(asientos.reduce((s,a)=>s+a.apuntes.reduce((s2,ap)=>s2+ap.haber,0),0))}</td>
              </tr></tfoot>
            </table>
          </div>
        </div>}
        {libroView==="mayor"&&<div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
            <SectionTitle>Libro mayor ‚Äî {year} ({mayor.length} cuentas)</SectionTitle>
            <button className="btn btn-sm btn-export" onClick={()=>exportCSV(mayor,`libro_mayor_${year}.csv`,[{label:"Cuenta",key:"nombre"},{label:"Debe",key:"debe"},{label:"Haber",key:"haber"},{label:"Saldo",key:"saldo"}])}>‚Üì CSV</button>
          </div>
          {mayor.map((m,i)=><div key={i} style={{background:"#fff",borderRadius:8,border:"1px solid #E4E9F0",marginBottom:10,overflow:"hidden"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 16px",background:"#FAFBFC",borderBottom:"1px solid #E4E9F0",cursor:"pointer"}} onClick={()=>{const el=document.getElementById(`mayor-${i}`);if(el)el.style.display=el.style.display==="none"?"block":"none"}}>
              <div style={{display:"flex",gap:12,alignItems:"center"}}>
                <span style={{fontSize:12,fontWeight:700,color:"#2E6B3A",fontFamily:"monospace"}}>{m.cuenta}</span>
                <span style={{fontSize:12,color:"#2C3E50"}}>{PGC[m.cuenta]||""}</span>
                <span style={{fontSize:10,color:"#999"}}>({m.movs.length} movs.)</span>
              </div>
              <div style={{display:"flex",gap:16,fontSize:11,fontFamily:"monospace"}}>
                <span>D: {fmt(m.debe)}</span>
                <span>H: {fmt(m.haber)}</span>
                <span style={{fontWeight:700,color:m.saldo>=0?"#2E6B3A":"#C0392B"}}>Saldo: {fmt(Math.abs(m.saldo))} {m.saldo>=0?"D":"H"}</span>
              </div>
            </div>
            <div id={`mayor-${i}`} style={{display:"none"}}>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:10}}>
                <thead><tr>{["Fecha","Concepto","Debe","Haber","Saldo"].map((h,j)=><th key={j} style={{padding:"6px 10px",textAlign:j>=2?"right":"left",color:"#7A8DA0",fontSize:9,borderBottom:"1px solid #E4E9F0",background:"#FAFBFC"}}>{h}</th>)}</tr></thead>
                <tbody>{(()=>{let s=0;return m.movs.map((mv,j)=>{s+=mv.debe-mv.haber;return <tr key={j}><td style={{padding:"4px 10px",borderBottom:"1px solid #F5F5F5"}}>{fmtDate(mv.fecha)}</td><td style={{padding:"4px 10px",borderBottom:"1px solid #F5F5F5",color:"#7A8DA0"}}>{mv.concepto}</td><td style={{padding:"4px 10px",borderBottom:"1px solid #F5F5F5",textAlign:"right",fontFamily:"monospace"}}>{mv.debe?fmt(mv.debe):""}</td><td style={{padding:"4px 10px",borderBottom:"1px solid #F5F5F5",textAlign:"right",fontFamily:"monospace"}}>{mv.haber?fmt(mv.haber):""}</td><td style={{padding:"4px 10px",borderBottom:"1px solid #F5F5F5",textAlign:"right",fontFamily:"monospace",fontWeight:600,color:s>=0?"#2E6B3A":"#C0392B"}}>{fmt(Math.abs(s))} {s>=0?"D":"H"}</td></tr>})})()}</tbody>
              </table>
            </div>
          </div>)}
        </div>}
        {libroView==="balance"&&<div>
          <SectionTitle>Balance de situaci√≥n ‚Äî {year}</SectionTitle>
          {OFFICIAL_CCAA[year] ? <OfficialBalanceView year={year} fmt={fmt}/> : <div style={{display:"flex",gap:16,flexWrap:"wrap"}}>
            <div style={{flex:1,minWidth:300,background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0"}}>
              <div style={{padding:"4px 0",fontSize:10,color:"#E67E22",marginBottom:8}}>‚ö†Ô∏è Calculado desde facturas ‚Äî datos posiblemente incompletos</div>
              <div style={{fontSize:13,fontWeight:700,color:"#2E6B3A",marginBottom:12,borderBottom:"2px solid #2E6B3A",paddingBottom:6}}>ACTIVO</div>
              {balance.activo.map((m,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",fontSize:12,borderBottom:"1px solid #F0F2F5"}}>
                <span style={{color:m.cuenta.startsWith("2")?"#2C3E50":"#7A8DA0"}}><span style={{fontFamily:"monospace",marginRight:6,fontSize:10}}>{m.cuenta}</span>{PGC[m.cuenta]||""}</span>
                <span style={{fontFamily:"monospace",color:m.saldo>=0?"#2E6B3A":"#C0392B"}}>{fmt(m.saldo)}</span>
              </div>)}
              <div style={{display:"flex",justifyContent:"space-between",padding:"10px 0",fontSize:14,fontWeight:700,borderTop:"2px solid #2E6B3A",marginTop:6}}>
                <span>TOTAL ACTIVO</span><span style={{fontFamily:"monospace",color:"#2E6B3A"}}>{fmt(balance.tActivo)}</span>
              </div>
            </div>
            <div style={{flex:1,minWidth:300,background:"#fff",borderRadius:10,padding:18,border:"1px solid #E4E9F0"}}>
              <div style={{padding:"4px 0",fontSize:10,color:"#E67E22",marginBottom:8}}>‚ö†Ô∏è Calculado desde facturas ‚Äî datos posiblemente incompletos</div>
              <div style={{fontSize:13,fontWeight:700,color:"#2980B9",marginBottom:12,borderBottom:"2px solid #2980B9",paddingBottom:6}}>PATRIMONIO NETO Y PASIVO</div>
              {balance.pasivo.map((m,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",fontSize:12,borderBottom:"1px solid #F0F2F5"}}>
                <span style={{color:"#7A8DA0"}}><span style={{fontFamily:"monospace",marginRight:6,fontSize:10}}>{m.cuenta}</span>{PGC[m.cuenta]||""}</span>
                <span style={{fontFamily:"monospace",color:"#2980B9"}}>{fmt(Math.abs(m.saldo))}</span>
              </div>)}
              <div style={{display:"flex",justifyContent:"space-between",padding:"5px 0",fontSize:12,borderBottom:"1px solid #F0F2F5",fontStyle:"italic"}}>
                <span style={{color:"#7A8DA0"}}>Resultado del ejercicio</span>
                <span style={{fontFamily:"monospace",color:pyg.resultado>=0?"#27AE60":"#C0392B"}}>{fmt(pyg.resultado)}</span>
              </div>
              <div style={{display:"flex",justifyContent:"space-between",padding:"10px 0",fontSize:14,fontWeight:700,borderTop:"2px solid #2980B9",marginTop:6}}>
                <span>TOTAL PN + PASIVO</span><span style={{fontFamily:"monospace",color:"#2980B9"}}>{fmt(balance.tPasivo+pyg.resultado)}</span>
              </div>
            </div>
          </div>}
        </div>}
        {libroView==="pyg"&&<div>
          <SectionTitle>Cuenta de p√©rdidas y ganancias ‚Äî {year}</SectionTitle>
          {OFFICIAL_CCAA[year] ? <OfficialPyGView year={year} fmt={fmt}/> : <div style={{background:"#fff",borderRadius:10,border:"1px solid #E4E9F0",overflow:"hidden"}}>
            <div style={{padding:"10px 20px",background:"#EAFAF1",fontWeight:700,fontSize:12,color:"#2E6B3A",borderBottom:"1px solid #A9DFBF"}}>A) INGRESOS DE EXPLOTACI√ìN</div>
            {pyg.ingresos.map((m,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"6px 20px 6px 36px",fontSize:12,borderBottom:"1px solid #F0F2F5"}}>
              <span style={{color:"#7A8DA0"}}><span style={{fontFamily:"monospace",marginRight:6,fontSize:10}}>{m.cuenta}</span>{PGC[m.cuenta]||""}</span>
              <span style={{fontFamily:"monospace"}}>{fmt(m.haber-m.debe)}</span>
            </div>)}
            <div style={{display:"flex",justifyContent:"space-between",padding:"8px 20px",fontWeight:700,fontSize:12,borderBottom:"2px solid #E4E9F0",background:"#FAFBFC"}}>
              <span>Total ingresos explotaci√≥n</span><span style={{fontFamily:"monospace",color:"#2E6B3A"}}>{fmt(pyg.tIngresos)}</span>
            </div>
            <div style={{padding:"10px 20px",background:"#FDEDEC",fontWeight:700,fontSize:12,color:"#C0392B",borderBottom:"1px solid #F5B7B1"}}>B) GASTOS DE EXPLOTACI√ìN</div>
            {pyg.gastos.map((m,i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"6px 20px 6px 36px",fontSize:12,borderBottom:"1px solid #F0F2F5"}}>
              <span style={{color:"#7A8DA0"}}><span style={{fontFamily:"monospace",marginRight:6,fontSize:10}}>{m.cuenta}</span>{PGC[m.cuenta]||""}</span>
              <span style={{fontFamily:"monospace"}}>{fmt(m.debe-m.haber)}</span>
            </div>)}
            <div style={{display:"flex",justifyContent:"space-between",padding:"8px 20px",fontWeight:700,fontSize:12,borderBottom:"2px solid #E4E9F0",background:"#FAFBFC"}}>
              <span>Total gastos explotaci√≥n</span><span style={{fontFamily:"monospace",color:"#C0392B"}}>{fmt(pyg.tGastos)}</span>
            </div>
            <div style={{display:"flex",justifyContent:"space-between",padding:"14px 20px",fontWeight:700,fontSize:15,background:"#FAFBFC"}}>
              <span>A.1) RESULTADO DE EXPLOTACI√ìN</span>
              <span style={{fontFamily:"monospace",color:pyg.resultado>=0?"#27AE60":"#C0392B"}}>{fmt(pyg.resultado)}</span>
            </div>
            <div style={{display:"flex",justifyContent:"space-between",padding:"10px 20px",fontSize:12,background:"#fff",borderTop:"1px solid #E4E9F0"}}>
              <span style={{color:"#7A8DA0"}}>{MODELO_200[year]?"IS (Mod. 200)":"IS (est. 25%)"}</span>
              <span style={{fontFamily:"monospace"}}>{fmt(MODELO_200[year]?MODELO_200[year].gastoIS:(pyg.resultado>0?pyg.resultado*0.25:0))}</span>
            </div>
            <div style={{display:"flex",justifyContent:"space-between",padding:"10px 20px",fontWeight:700,fontSize:13,background:"#FAFBFC",borderTop:"1px solid #E4E9F0"}}>
              <span>RESULTADO DESPU√âS DE IMPUESTOS</span>
              <span style={{fontFamily:"monospace",color:pyg.resultado>=0?"#27AE60":"#C0392B"}}>{fmt(MODELO_200[year]?MODELO_200[year].resultadoEjercicio:(pyg.resultado>0?pyg.resultado*0.75:pyg.resultado))}</span>
            </div>
          </div>}
        </div>}
        {libroView==="docs"&&<div>
          <SectionTitle>Documentos contables y corporativos ‚Äî {year}</SectionTitle>
          <div style={{display:"flex",gap:8,flexWrap:"wrap",marginBottom:16}}>
            {(yearDocs[year]||[]).map((d,i)=><DocLink key={i} d={d}/>)}
            {ccaaDoc[year]&&<DocLink d={{label:`CCAA ${year}`,doc:ccaaDoc[year]}}/>}
            <DocLink d={{label:"Balance y PyG hist√≥rico",doc:"docs/corporativo/BSPyG.xlsx"}}/>
            <DocLink d={{label:"Escritura constituci√≥n",doc:"docs/corporativo/2021BTC0523.pdf"}}/>
            <DocLink d={{label:"Certificado firma",doc:"docs/corporativo/CertFirmaEPDF.pdf"}}/>
          </div>
          {year<=2022&&<div style={{fontSize:11,color:"#7A8DA0",fontStyle:"italic"}}>Ejercicio cerrado ‚Äî CCAA aprobadas y depositadas</div>}
          {year===2023&&<div style={{fontSize:11,color:"#E67E22"}}>Ejercicio cerrado ‚Äî CCAA pendientes de dep√≥sito (balance seg√∫n Modelo 200 presentado)</div>}
          {year>=2024&&<div style={{fontSize:11,color:"#E67E22"}}>Ejercicio en curso ‚Äî contabilidad viva</div>}
        </div>}
      </div>;
    }
    return null;
  };
  return (
    <div style={{display:"flex",height:"100vh",fontFamily:"system-ui,-apple-system,sans-serif",background:"#F4F6F9",color:"#2C3E50",overflow:"hidden"}}>
      {/* MODALS */}
      {modalEmitida && <ModalEmitida item={modalEmitida.id?modalEmitida:null} onSave={saveEmitida} onClose={()=>setModalEmitida(null)}/>}
      {modalRecibida && <ModalRecibida item={modalRecibida.id?modalRecibida:null} onSave={saveRecibida} onClose={()=>setModalRecibida(null)}/>}
      {confirmDelete && <ConfirmDialog msg={`¬øEliminar esta factura${confirmDelete.type==="emitida"?" emitida":" recibida"}?`} onYes={()=>confirmDelete.type==="emitida"?deleteEmitida(confirmDelete.item):deleteRecibida(confirmDelete.item)} onNo={()=>setConfirmDelete(null)}/>}
      {/* SIDEBAR */}
      {sideOpen&&<div style={{width:240,minWidth:240,background:"#fff",borderRight:"1px solid #E4E9F0",display:"flex",flexDirection:"column"}} className="no-print">
        <div style={{padding:"16px 20px",borderBottom:"1px solid #E4E9F0"}}>
          <img src={LOGO_SRC} alt="Aznar Legal & Compliance" style={{width:"100%",maxWidth:200,height:"auto"}}/>
          <div style={{marginTop:6,fontSize:11,color:"#7A8DA0",fontFamily:"monospace",letterSpacing:0.5}}>NIF: B67038695</div>
        </div>
        <div style={{padding:"10px 6px",flex:1,display:"flex",flexDirection:"column",gap:1}}>
          <NavItem icon="‚óà" label="Dashboard" active={section==="dashboard"} onClick={()=>{setSection("dashboard");setSearch("");setLibroView(null);}}/>
          <NavItem icon="‚Üó" label="Facturas Emitidas" active={section==="emitidas"} onClick={()=>{setSection("emitidas");setSearch("");setLibroView(null);}} badge={emitidas.length}/>
          <NavItem icon="‚Üô" label="Facturas Recibidas" active={section==="recibidas"} onClick={()=>{setSection("recibidas");setSearch("");setLibroView(null);}} badge={recibidas.length}/>
          <div style={{height:1,background:"#E4E9F0",margin:"6px 16px"}}/>
          <NavItem icon="%" label="IVA / Mod. 303" active={section==="iva"} onClick={()=>setSection("iva")}/>
          <NavItem icon="‚öñ" label="Reconciliaci√≥n IVA" active={section==="reconciliacion"} onClick={()=>setSection("reconciliacion")}/>
          <NavItem icon="¬ß" label="Impuesto Sociedades" active={section==="is"} onClick={()=>setSection("is")}/>
          <div style={{height:1,background:"#E4E9F0",margin:"6px 16px"}}/>
          <NavItem icon="‚ö†" label="Alertas" active={section==="alertas"} onClick={()=>setSection("alertas")} badge={ALERTAS.length}/>
          <NavItem icon="üìö" label="Libros y Actas" active={section==="libros"} onClick={()=>setSection("libros")}/>
        </div>
        <div style={{padding:"12px 20px",borderTop:"1px solid #E4E9F0",fontSize:10,color:"#A0AEBB"}}>Plataforma Contable v5.0 ¬∑ Modular ¬∑ Evoluci√≥n + Reconciliaci√≥n</div>
      </div>}
      {/* MAIN */}
      <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"auto"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 24px",borderBottom:"1px solid #E4E9F0",background:"#fff"}} className="no-print">
          <div style={{display:"flex",alignItems:"center",gap:12}}>
            <button onClick={()=>setSideOpen(!sideOpen)} style={{background:"none",border:"1px solid #D5DCE4",color:"#7A8DA0",cursor:"pointer",width:32,height:32,borderRadius:6,display:"flex",alignItems:"center",justifyContent:"center",fontSize:15}}>‚ò∞</button>
            <span style={{color:"#2E6B3A",fontSize:16,fontWeight:700}}>{sections[section]}</span>
          </div>
          <div style={{display:"flex",gap:3,flexWrap:"nowrap",overflowX:"auto"}}>
            {[2017,2018,2019,2020,2021,2022,2023,2024,2025,2026].map(y=><button key={y} onClick={()=>{setYear(y);setSearch("");setLibroView(null);}} style={{padding:"4px 8px",borderRadius:6,border:year===y?"2px solid #3D7A4A":"1px solid #D5DCE4",background:year===y?"#3D7A4A":"#fff",color:year===y?"#fff":"#7A8DA0",cursor:"pointer",fontSize:10,fontWeight:700,fontFamily:"monospace",whiteSpace:"nowrap",flexShrink:0}}>{y}</button>)}
          </div>
        </div>
        <div style={{flex:1,overflow:"auto",padding:24}}>{renderSection()}</div>
      </div>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
